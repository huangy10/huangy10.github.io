<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description" content="随便写写"><meta name="keywords" content="Hexo, Gruntjs, Nodejs, Reactjs, Vuejs"><title>SimpleOpenNI在Processing导出应用中的库引用问题 - 治部少辅</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.ico"><script src="https://cdn-city.livere.com/js/embed.dist.js" async></script></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a href="https://github.com/huangy10"><span>Github</span></a></li><li><a href="/archives"><span>Archives</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><label class="navi-button light" for="navi">MENU</label><img class="background" src="https://i.loli.net/2018/11/05/5bdfeccbb2696.jpg"><div class="post-title"><h1 class="title">SimpleOpenNI在Processing导出应用中的库引用问题</h1><ul class="meta"><li><i class="icon icon-author"></i>Woody Huang</li><li><i class="icon icon-clock"></i>19 Minutes</li><li><i class="icon icon-calendar"></i>February 22, 2019</li></ul></div></div><div class="article-content" style="max-width:800px"><p>在Processing中使用SimpleOpenNI时，如果尝试将本来能够正常运行的pde文件导出成应用，那么在运行时会出现<code>java.lang.UnsatisfiedLinkError</code>这个错误。详细信息如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Can&apos;t load SimpleOpenNI library (libSimpleOpenNI.jnilib) : java.lang.UnsatisfiedLinkError: Can&apos;t load library: /SimpleOpenNI/library/libSimpleOpenNI.jnilib</span><br><span class="line">Verify if you installed SimpleOpenNI correctly.</span><br><span class="line">http://code.google.com/p/simple-openni/wiki/Installation</span><br><span class="line"></span><br><span class="line">java.lang.UnsatisfiedLinkError: SimpleOpenNI.SimpleOpenNIJNI.swig_module_init()V</span><br><span class="line">	at SimpleOpenNI.SimpleOpenNIJNI.swig_module_init(Native Method)</span><br><span class="line">	at SimpleOpenNI.SimpleOpenNIJNI.&lt;clinit&gt;(SimpleOpenNIJNI.java:290)</span><br><span class="line">	at SimpleOpenNI.ContextWrapper.&lt;init&gt;(ContextWrapper.java:54)</span><br><span class="line">	at SimpleOpenNI.SimpleOpenNI.&lt;init&gt;(SimpleOpenNI.java:253)</span><br><span class="line">	at Sketch.settings(Sketch.java:28)</span><br><span class="line">	at processing.core.PApplet.handleSettings(PApplet.java:954)</span><br><span class="line">	at processing.core.PApplet.runSketch(PApplet.java:10786)</span><br><span class="line">	at processing.core.PApplet.main(PApplet.java:10511)</span><br><span class="line">	at Main.main(Main.java:7)</span><br></pre></td></tr></table></figure>
<p>根据错误信息，是在读取<code>libSimpleOpenNI.jnilib</code>这个库文件时失败导致的。奇怪的是，程序尝试读取的路径是：<code>/SimpleOpenNI/library/libSimpleOpenNI.jnilib</code>。这是一个很奇怪的绝对路径。也<a href="https://forum.processing.org/two/discussion/1253/has-anyone-successfully-exported-a-processing-app-using-simple-openni-on-mac-os-x" target="_blank" rel="noopener">有人</a>尝试直接将库文件复制到这个全局路径的位置，可以让程序运行起来。可是这种方法也太不优雅了。</p>
<h2 id="为什么会出现这种现象？"><a href="#为什么会出现这种现象？" class="headerlink" title="为什么会出现这种现象？"></a>为什么会出现这种现象？</h2><p>通过IntelliJ可以打开<code>SimpleOpenNI.jar</code>查看代码细节。可以看到<code>SimpleOpenNI.class</code>中确定载入库文件路径的方式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">        String var0 = System.getProperty(<span class="string">"os.name"</span>).toLowerCase();</span><br><span class="line">        String var1 = <span class="string">"SimpleOpenNI"</span>;</span><br><span class="line">        String var2 = System.getProperty(<span class="string">"os.arch"</span>).toLowerCase();</span><br><span class="line">        <span class="keyword">if</span> (var0.indexOf(<span class="string">"win"</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var0.indexOf(<span class="string">"nix"</span>) &lt; <span class="number">0</span> &amp;&amp; var0.indexOf(<span class="string">"linux"</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (var0.indexOf(<span class="string">"mac"</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                var1 = <span class="string">"lib"</span> + var1 + <span class="string">".jnilib"</span>;</span><br><span class="line">                nativLibPath = getLibraryPathLinux() + <span class="string">"/SimpleOpenNI/library/"</span>;</span><br><span class="line">                nativDepLibPath = nativLibPath + <span class="string">"osx/"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            nativLibPath = <span class="string">"/SimpleOpenNI/library/linux"</span>;</span><br><span class="line">            <span class="keyword">if</span> (var2.indexOf(<span class="string">"86"</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                var1 = var1 + <span class="string">"32"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var2.indexOf(<span class="string">"64"</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                var1 = <span class="string">"lib"</span> + var1 + <span class="string">"64.so"</span>;</span><br><span class="line">                nativLibPath = getLibraryPathLinux() + <span class="string">"/SimpleOpenNI/library/"</span>;</span><br><span class="line">                nativDepLibPath = nativLibPath + <span class="string">"linux64/"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.load(nativLibPath + var1);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsatisfiedLinkError var5) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Can't load SimpleOpenNI library ("</span> + var1 + <span class="string">") : "</span> + var5);</span><br><span class="line">            System.out.println(<span class="string">"Verify if you installed SimpleOpenNI correctly.\nhttp://code.google.com/p/simple-openni/wiki/Installation"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _initFlag = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>注意到在生成库文件路径时，<code>/SimpleOpenNI/library/libSimpleOpenNI.jnilib</code>，前面应该会添加<code>getLibraryPathLinux()</code>的结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getLibraryPathLinux</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        URL var0 = SimpleOpenNI.class.getResource(<span class="string">"SimpleOpenNI.class"</span>);</span><br><span class="line">        <span class="keyword">if</span> (var0 != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String var1 = var0.toString().replace(<span class="string">"%20"</span>, <span class="string">" "</span>);</span><br><span class="line">            <span class="keyword">int</span> var2 = var1.indexOf(<span class="number">47</span>);</span><br><span class="line">            <span class="keyword">boolean</span> var3 = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">int</span> var4 = var1.indexOf(<span class="string">"/SimpleOpenNI/library"</span>);</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span> &lt; var2 &amp;&amp; -<span class="number">1</span> &lt; var4 ? var1.substring(var2, var4) : <span class="string">""</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>我尝试了在不同环境下,<code>SimpleOpenNI.class.getResource(&quot;SimpleOpenNI.class&quot;)</code>下运行的结果。发现：</p>
<ol>
<li>在pde运行时，获取到的是独立的<code>SimpleOpenNI.jar</code>下的路径，例如：<code>/Users/lena/Documents/Processing/libraries/SimpleOpenNI/library/SimpleOpenNI.jar!/SimpleOpenNI/SimpleOpenNI.class</code></li>
<li>在导出应用中运行时，获取到的是打包后应用内的，例如<code>.../MySketch/application.macosx/MySketch.app/Contents/Java/SimpleOpenNI.jar!/SimpleOpenNI/SimpleOpenNI.class</code></li>
</ol>
<p>在函数<code>getLibraryPathLinux</code>中，程序会定位<code>/SimpleOpenNI/library</code>这个字符串，然后取出这个子字符串前的内容构成的路径。上述第二种情形内，SimpleOpenNI.jar被打包到应用内后，不在处于<code>/SimpleOpenNI/library</code>这个前缀目录下，所以导致定位失败。</p>
<h2 id="如何解决这个问题。"><a href="#如何解决这个问题。" class="headerlink" title="如何解决这个问题。"></a>如何解决这个问题。</h2><p>在无法直接修改SimpleOpenNI的源代码的情况下，要修复这个问题，就要想办法把<code>SimpleOpenNI.jar</code>放到<code>SimpleOpenNI/library</code>目录下。我使用的macOS系统，下面的方法都是在Mac下测试。不过基本思路可以迁移到Windows上。</p>
<p>在生成的App上右键选择显示包内容。可以查看其内部结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── Info.plist</span><br><span class="line">├── Java</span><br><span class="line">│   ├── Sketch.jar</span><br><span class="line">│   ├── NiTE2</span><br><span class="line">│   ├── SimpleOpenNI.jar</span><br><span class="line">│   ├── SimpleOpenNI32.dll</span><br><span class="line">│   ├── SimpleOpenNI64.dll</span><br><span class="line">│   ├── core.jar</span><br><span class="line">│   ├── data</span><br><span class="line">│   ├── gluegen-rt-natives-macosx-universal.jar</span><br><span class="line">│   ├── gluegen-rt.jar</span><br><span class="line">│   ├── javamp3-1.0.3.jar</span><br><span class="line">│   ├── jogl-all-natives-macosx-universal.jar</span><br><span class="line">│   ├── jogl-all.jar</span><br><span class="line">│   ├── jsyn-20171016.jar</span><br><span class="line">│   ├── libSimpleOpenNI.jnilib</span><br><span class="line">│   ├── libSimpleOpenNI64.so</span><br><span class="line">│   ├── osx</span><br><span class="line">│   ├── sound.jar</span><br><span class="line">│   ├── win32</span><br><span class="line">│   └── win64</span><br><span class="line">├── MacOS</span><br><span class="line">│   └── Sketch</span><br><span class="line">├── PkgInfo</span><br><span class="line">├── PlugIns</span><br><span class="line">│   └── jdk1.8.0_181.jdk</span><br><span class="line">└── Resources</span><br><span class="line">    ├── en.lproj</span><br><span class="line">    └── sketch.icns</span><br></pre></td></tr></table></figure>
<p>可以看到<code>SimpleOpenNI.jar</code>位于<code>Java</code>目录下。我尝试过直接在此处创建目录<code>SimpleOpenNI/library</code>并把<code>SimpleOpenNI.jar</code>放进去。但是运行提示无法找到<code>SimpleOpenNI.jar</code>。这需要在APP运行时进一步指定<code>CLASSPATH</code>。有一种方法是直接在Info.plist文件里面添加<code>-Djava.class.path</code>运行属性，或者添加<code>ClASSPATH</code>环境变量，但是这种方法会要求你手动填写所有需要使用的jar依赖，甚至是包括processing的jar文件。这对于后续维护和修改很不利。所以这里我采取了另一种取巧的办法。</p>
<p>进入<code>Contents/MacOS</code>目录，删除原来的<code>Sketch</code>文件(你看到的应该是和你的Processing程序同名的文件，我这里用Sketch来代替)。新建一个同名的空白的文本文件，然后在文件中添加如下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">cd</span> <span class="string">"<span class="variable">$(dirname $&#123;BASH_SOURCE&#125;)</span>"</span></span><br><span class="line"><span class="built_in">cd</span> ../..</span><br><span class="line">APP_ROOT=$(<span class="built_in">pwd</span>)</span><br><span class="line"><span class="built_in">cd</span> Contents/Java</span><br><span class="line"></span><br><span class="line">JAR_LIBS=$(ls *.jar | tr <span class="string">"\n"</span> <span class="string">":"</span>)</span><br><span class="line"><span class="comment"># 添加SimpleOpenNI.jar</span></span><br><span class="line">JAR_LIBS=<span class="variable">$&#123;JAR_LIBS&#125;</span>./SimpleOpenNI/library/SimpleOpenNI.jar</span><br><span class="line"></span><br><span class="line">APP_NAME=$(basename <span class="string">"<span class="variable">$&#123;BASH_SOURCE&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意：如果你内嵌的jdk的版本不同，要把jdk1.8.0_181.jdk替换成对应的版本</span></span><br><span class="line"><span class="comment"># 如果你没有在app内部内嵌jdk，这里修改成JAVA_BIN=java，使用系统全局的java即可</span></span><br><span class="line">JAVA_BIN=<span class="variable">$&#123;APP_ROOT&#125;</span>/Contents/PlugIns/jdk1.8.0_181.jdk/Contents/Home/jre/bin/java</span><br><span class="line"></span><br><span class="line"><span class="variable">$&#123;JAVA_BIN&#125;</span> \</span><br><span class="line">-Djna.nosys=<span class="literal">true</span> \</span><br><span class="line">-Djava.ext.dirs=<span class="variable">$APP_ROOT</span>/Contents/PlugIns/jdk1.8.0_181.jdk/Contents/Home/jre/lib/ext \</span><br><span class="line">-Xdock:icon=<span class="variable">$APP_ROOT</span>/Contents/Resources/sketch.icns \</span><br><span class="line">-Djava.library.path=<span class="variable">$APP_ROOT</span>/Contents/Java \</span><br><span class="line">-Dapple.laf.useScreenMenuBar=<span class="literal">true</span> \</span><br><span class="line">-Dcom.apple.macos.use-file-dialog-packages=<span class="literal">true</span> \</span><br><span class="line">-Dcom.apple.macos.useScreenMenuBar=<span class="literal">true</span> \</span><br><span class="line">-Dcom.apple.mrj.application.apple.menu.about.name=<span class="variable">$&#123;APP_NAME&#125;</span> \</span><br><span class="line">-classpath <span class="variable">$&#123;JAR_LIBS&#125;</span> <span class="variable">$&#123;APP_NAME&#125;</span></span><br></pre></td></tr></table></figure>
<p>为这个文件添加可执行权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x ./Sketch</span><br></pre></td></tr></table></figure>
<p>将<code>~/Documents/Processing/libraries/SimpleOpenNI</code>整个文件夹拷贝进导出APP的<code>Contents/Java目录下</code>。然后就可以运行了。</p>
<p>文章链接 <a href="http://www.codewoody.com/posts/undefined/">http://www.codewoody.com/posts/undefined/</a> </p>
</div><div class="article-meta" style="max-width:800px"></div><div class="article-comment" id="lv-container" data-id="city" data-uid="MTAyMC80MDkyMC8xNzQ0NQ==" style="max-width:800px"></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/posts/6289/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/huangy10" title="Github" target="_blank"><i class="icon icon-github"></i></a></li><li><a href="https://www.zhihu.com/people/woody-huang" title="Zhihu" target="_blank"><i class="icon icon-zhihu"></i></a></li><li><a href="mailto:woodyhuang1@gmail.com" title="Email" target="_blank"><i class="icon icon-email"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2019 治部少辅<br><small>POWER BY <a href="https://hexo.io" target="_blank">HEXO</a></small><small>, THEME BY <a href="https://github.com/BoizZ/hexo-theme-laughing" target="_blank">LAUGHING</a></small></p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script><script src="https://www.googletagmanager.com/gtag/js?id=UA-114736006-1" async></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114736006-1');</script></body></html>