<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description" content="éšä¾¿å†™å†™"><meta name="keywords" content="Hexo, Gruntjs, Nodejs, Reactjs, Vuejs"><title>Gitlab|å®‰è£…-è¿ç§»-åˆ é™¤ - æ²»éƒ¨å°‘è¾…</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.ico"><script src="https://cdn-city.livere.com/js/embed.dist.js" async></script></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a href="https://github.com/huangy10"><span>Github</span></a></li><li><a href="/archives"><span>Archives</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><label class="navi-button light" for="navi">MENU</label><img class="background" src="https://i.loli.net/2018/11/05/5bdfeccbb2696.jpg"><div class="post-title"><h1 class="title">Gitlab|å®‰è£…-è¿ç§»-åˆ é™¤</h1><ul class="meta"><li><i class="icon icon-author"></i>Woody Huang</li><li><i class="icon icon-clock"></i>19 Minutes</li><li><i class="icon icon-calendar"></i>December 10, 2018</li></ul></div></div><div class="article-content" style="max-width:800px"><p></p>
<h1 id="1-å®‰è£…"><a href="#1-å®‰è£…" class="headerlink" title="1 å®‰è£…"></a>1 å®‰è£…</h1><h2 id="1-1-Omnibus-package-installation"><a href="#1-1-Omnibus-package-installation" class="headerlink" title="1.1 Omnibus package installation"></a>1.1 Omnibus package installation</h2><p>è¿™æ˜¯Gitlabå®˜ç½‘æ¨èçš„å®‰è£…æ–¹å¼ã€‚å®˜ç½‘æ–‡æ¡£é“¾æ¥ä½äº<a href="https://gitlab.com/gitlab-org/gitlab-recipes/blob/master/web-server/nginx/gitlab-omnibus-nginx.conf" target="_blank" rel="noopener">Gitlab Installation</a>ã€‚ä¸è¿‡ï¼Œç°åœ¨ç›´æ¥å»å®˜ç½‘é»˜è®¤ç»™å‡ºçš„æ˜¯ä¼ä¸šç‰ˆï¼Œå³gitlab-eeçš„å®‰è£…æ–¹å¼ï¼ˆä»˜è´¹çš„ï¼‰ï¼Œè€Œä¸ªäººç‰ˆå…¶å®ç”¨gitlab-ceå°±å¤Ÿäº†ã€‚gitlab-ceå®‰è£…æ–¹å¼å¦‚ä¸‹</p>
<h3 id="1-1-1-å®‰è£…å¹¶é…ç½®ä¾èµ–"><a href="#1-1-1-å®‰è£…å¹¶é…ç½®ä¾èµ–" class="headerlink" title="1.1.1 å®‰è£…å¹¶é…ç½®ä¾èµ–"></a>1.1.1 å®‰è£…å¹¶é…ç½®ä¾èµ–</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y curl openssh-server ca-certificates</span><br></pre></td></tr></table></figure>
<p>ç„¶åå®‰è£…Postfixæ¥å¯åŠ¨é‚®ä»¶æé†’åŠŸèƒ½ã€‚ï¼ˆå¦‚æœä½ ä½¿ç”¨äº†ç¬¬ä¸‰æ–¹çš„é‚®ä»¶æœåŠ¡ï¼Œå¯ä»¥è·³è¿‡è¿™ä¸€æ­¥å¹¶ä¸”å‚ç…§<a href="https://docs.gitlab.com/omnibus/settings/smtp.html" target="_blank" rel="noopener">é…ç½®å¤–éƒ¨SMTPæœåŠ¡å™¨</a>ï¼‰ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y postfix</span><br></pre></td></tr></table></figure>
<p>åœ¨æ¥ä¸‹æ¥çš„é…ç½®è¿‡ç¨‹ä¸­ï¼Œé€‰æ‹©â€™Internet Siteâ€™é€‰é¡¹ã€‚ä½¿ç”¨ä½ çš„æœåŠ¡å™¨çš„åŸŸåæ¥ä½œä¸ºâ€™mail nameâ€™ã€‚å¦‚æœè¿˜æœ‰åç»­çš„é€‰é¡¹ï¼Œè¾“å…¥Enterç›´è‡³å®‰è£…å®Œæˆã€‚</p>
<h3 id="1-1-2-å®‰è£…Gitlab-EE"><a href="#1-1-2-å®‰è£…Gitlab-EE" class="headerlink" title="1.1.2 å®‰è£…Gitlab-EE"></a>1.1.2 å®‰è£…Gitlab-EE</h3><p>æ·»åŠ Gitlab Packageä»“åº“ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | sudo bash</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ³¨æ„è¿™é‡Œå®‰è£…çš„æ˜¯CEç‰ˆæœ¬ï¼Œæ•…æ˜¯gitlab-ceï¼Œä¼ä¸šç‰ˆå¯¹åº”çš„æ˜¯gitlab-ee</p>
</blockquote>
<p>æ¥ä¸‹æ¥å®‰è£…Gitlabï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo EXTERNAL_URL=<span class="string">"http://gitlab.example.com"</span> apt-get install gitlab-ce</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„EXTERNAL_URLæ˜¯ä½ çš„GitlabæœåŠ¡è¦ä½¿ç”¨çš„åŸŸåã€‚å¦‚æœä½ åªä½¿ç”¨httpï¼Œæˆ–è€…åç»­è¦ä½¿ç”¨å·²æœ‰çš„Nginxï¼Œå¯ä»¥åœ¨è¿™é‡Œä½¿ç”¨httpã€‚å¦‚æœä½¿ç”¨httpsï¼Œgitlabä¼šè°ƒç”¨<a href="https://letsencrypt.org" target="_blank" rel="noopener">Letâ€™s encrtpy</a>çš„æœåŠ¡ä¸ºä½ çš„ç½‘ç«™æ·»åŠ sslè¯ä¹¦ã€‚</p>
<h3 id="1-1-3-ç™»å½•Gtilab"><a href="#1-1-3-ç™»å½•Gtilab" class="headerlink" title="1.1.3 ç™»å½•Gtilab"></a>1.1.3 ç™»å½•Gtilab</h3><p>è¿›å…¥ä½ åœ¨å®‰è£…é˜¶æ®µçš„åŸŸåï¼Œä½ ä¼šè¢«é‡å®šå‘åˆ°å¯†ç é‡ç½®ç•Œé¢ã€‚åœ¨è¿™ä¸ªé¡µé¢ä½ è¦è®¾ç½®ç®¡ç†å‘˜è´¦æˆ·çš„å¯†ç ï¼Œç„¶åå›åˆ°ç™»å½•ç•Œé¢ã€‚åœ¨è¿™ä¸ªç™»å½•ç•Œé¢ï¼Œä½¿ç”¨<code>root</code>ç”¨æˆ·åå’Œä¸Šä¸€æ­¥è®¾ç½®çš„å¯†ç ç™»å½•ã€‚</p>
<h2 id="1-2-ä½¿ç”¨å·²æœ‰çš„Nginx"><a href="#1-2-ä½¿ç”¨å·²æœ‰çš„Nginx" class="headerlink" title="1.2 ä½¿ç”¨å·²æœ‰çš„Nginx"></a>1.2 ä½¿ç”¨å·²æœ‰çš„Nginx</h2><p>è¿™ä¸ªç« èŠ‚æˆ‘ä»¬å‚è€ƒ<a href="https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/doc/settings/nginx.md#using-a-non-bundled-web-server" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>ç»™å‡ºä½¿ç”¨å·²æœ‰çš„Nginxçš„æ–¹æ³•ã€‚</p>
<h3 id="1-2-1-ç¦ç”¨Gitlabè‡ªå¸¦çš„Nginx"><a href="#1-2-1-ç¦ç”¨Gitlabè‡ªå¸¦çš„Nginx" class="headerlink" title="1.2.1 ç¦ç”¨Gitlabè‡ªå¸¦çš„Nginx"></a>1.2.1 ç¦ç”¨Gitlabè‡ªå¸¦çš„Nginx</h3><p>ç¼–è¾‘<code>/etc/gitlab/gitlab.rb</code>æ–‡ä»¶ï¼Œè®¾ç½®</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx[<span class="string">'enable'</span>] = <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<h3 id="1-2-2-è®¾ç½®å¤–éƒ¨æœåŠ¡å™¨çš„ç”¨æˆ·"><a href="#1-2-2-è®¾ç½®å¤–éƒ¨æœåŠ¡å™¨çš„ç”¨æˆ·" class="headerlink" title="1.2.2 è®¾ç½®å¤–éƒ¨æœåŠ¡å™¨çš„ç”¨æˆ·"></a>1.2.2 è®¾ç½®å¤–éƒ¨æœåŠ¡å™¨çš„ç”¨æˆ·</h3><p>è¿™ä¸€æ­¥æ˜¯ä¸ºäº†ä¿è¯å¤–éƒ¨æœåŠ¡å™¨ç”¨æˆ·èƒ½å¤Ÿè®¿é—®gitlabã€‚ä½¿ç”¨Nginxæ—¶ï¼Œå¯ä»¥é€šè¿‡<code>/etc/nginx/nginx.conf</code>æ–‡ä»¶æŸ¥çœ‹åˆ°nginxç”¨æˆ·ã€‚ä¸€èˆ¬æƒ…å†µä¸‹è¿™ä¸ªç”¨æˆ·åæ˜¯<code>www-data</code>ã€‚ä¿®æ”¹<code>/etc/gitlab/gitlab.rb</code>ï¼š</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web_server[<span class="string">'external_users'</span>] = [<span class="string">'www-data'</span>]</span><br></pre></td></tr></table></figure>
<p>ç„¶åä½¿ç”¨<code>sudo gitlab-ctl reconfigure</code>æ¥ä½¿å¾—æ›´æ”¹ç”Ÿæ•ˆã€‚</p>
<h3 id="1-2-3-Trusted-proxies"><a href="#1-2-3-Trusted-proxies" class="headerlink" title="1.2.3 Trusted proxies"></a>1.2.3 Trusted proxies</h3><p>å¦‚æœä½ çš„åå‘ä»£ç†æœåŠ¡å™¨å’Œgitlabä¸æ˜¯åœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œé‚£ä¹ˆä½ è¿˜éœ€è¦è®¾ç½®Trusted proxiesã€‚</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab_rails[<span class="string">'trusted_proxies'</span>] = [<span class="string">'192.168.1.0/24'</span>, <span class="string">'192.168.2.1'</span>, <span class="string">'2001:0db8::/32'</span>]</span><br></pre></td></tr></table></figure>
<h3 id="1-2-4-Nginxç¤ºä¾‹é…ç½®æ–‡ä»¶"><a href="#1-2-4-Nginxç¤ºä¾‹é…ç½®æ–‡ä»¶" class="headerlink" title="1.2.4 Nginxç¤ºä¾‹é…ç½®æ–‡ä»¶"></a>1.2.4 Nginxç¤ºä¾‹é…ç½®æ–‡ä»¶</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gitlab socket æ–‡ä»¶åœ°å€</span></span><br><span class="line"><span class="attribute">upstream</span> gitlab &#123;</span><br><span class="line">  <span class="comment"># 7.x ç‰ˆæœ¬åœ¨æ­¤ä½ç½®</span></span><br><span class="line">  <span class="comment"># server unix:/var/opt/gitlab/gitlab-rails/tmp/sockets/gitlab.socket;</span></span><br><span class="line">  <span class="comment"># 8.0 ä½ç½®</span></span><br><span class="line">  <span class="attribute">server</span> unix:/var/opt/gitlab/gitlab-rails/sockets/gitlab.socket;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> *:<span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">server_name</span> gitlab.example.com;   <span class="comment"># è¯·ä¿®æ”¹ä¸ºä½ çš„åŸŸå</span></span><br><span class="line"></span><br><span class="line">  <span class="attribute">server_tokens</span> <span class="literal">off</span>;     <span class="comment"># don't show the version number, a security best practice</span></span><br><span class="line">  <span class="attribute">root</span> /opt/gitlab/embedded/service/gitlab-rails/public;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Increase this if you want to upload large attachments</span></span><br><span class="line">  <span class="comment"># Or if you want to accept large git objects over http</span></span><br><span class="line">  <span class="attribute">client_max_body_size</span> <span class="number">250m</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># individual nginx logs for this gitlab vhost</span></span><br><span class="line">  <span class="attribute">access_log</span>  /var/log/gitlab/nginx/gitlab_access.log;</span><br><span class="line">  <span class="attribute">error_log</span>   /var/log/gitlab/nginx/gitlab_error.log;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="comment"># serve static files from defined root folder;.</span></span><br><span class="line">    <span class="comment"># @gitlab is a named location for the upstream fallback, see below</span></span><br><span class="line">    <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/index.html <span class="variable">$uri</span>.html <span class="variable">@gitlab</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># if a file, which is not found in the root folder is requested,</span></span><br><span class="line">  <span class="comment"># then the proxy pass the request to the upsteam (gitlab unicorn)</span></span><br><span class="line">  <span class="attribute">location</span> <span class="variable">@gitlab</span> &#123;</span><br><span class="line">    <span class="comment"># If you use https make sure you disable gzip compression</span></span><br><span class="line">    <span class="comment"># to be safe against BREACH attack</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">proxy_read_timeout</span> <span class="number">300</span>; <span class="comment"># Some requests take more than 30 seconds.</span></span><br><span class="line">    <span class="attribute">proxy_connect_timeout</span> <span class="number">300</span>; <span class="comment"># Some requests take more than 30 seconds.</span></span><br><span class="line">    <span class="attribute">proxy_redirect</span>     <span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">proxy_set_header</span>   X-Forwarded-Proto https;</span><br><span class="line">    <span class="attribute">proxy_set_header</span>   Host              <span class="variable">$http_host</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span>   X-Real-IP         <span class="variable">$remote_addr</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span>   X-Forwarded-For   <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span>   X-Frame-Options   SAMEORIGIN;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">proxy_pass</span> http://gitlab;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Enable gzip compression as per rails guide: http://guides.rubyonrails.org/asset_pipeline.html#gzip-compression</span></span><br><span class="line">  <span class="comment"># WARNING: If you are using relative urls do remove the block below</span></span><br><span class="line">  <span class="comment"># See config/application.rb under "Relative url support" for the list of</span></span><br><span class="line">  <span class="comment"># other files that need to be changed for relative url support</span></span><br><span class="line">  <span class="attribute">location</span> <span class="regexp">~ ^/(assets)/</span>  &#123;</span><br><span class="line">    <span class="attribute">root</span> /opt/gitlab/embedded/service/gitlab-rails/public;</span><br><span class="line">    <span class="comment"># gzip_static on; # to serve pre-gzipped version</span></span><br><span class="line">    <span class="attribute">expires</span> max;</span><br><span class="line">    <span class="attribute">add_header</span> Cache-Control public;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># error_page 502 /502.html;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2-è¿ç§»"><a href="#2-è¿ç§»" class="headerlink" title="2 è¿ç§»"></a>2 è¿ç§»</h1><h2 id="2-1-å¤‡ä»½"><a href="#2-1-å¤‡ä»½" class="headerlink" title="2.1 å¤‡ä»½"></a>2.1 å¤‡ä»½</h2><p>è¿ç§»é¦–å…ˆè¦åšçš„æ˜¯å¤‡ä»½ã€‚åœ¨<a href="https://blog.csdn.net/ouyang_peng/article/details/77070977" target="_blank" rel="noopener">gitå­¦ä¹ â€”â€”&gt; Gitlabå¦‚ä½•è¿›è¡Œå¤‡ä»½æ¢å¤ä¸è¿ç§»ï¼Ÿ</a>è¿™ç¯‡æ–‡ç« ä¸­è¯¦ç»†è®²è¿°äº†å¤‡ä»½çš„é—®é¢˜ã€‚æˆ‘ä»¬è¿™é‡Œä»‹ç»çš„æ˜¯æœ€ä¸ºç›´æ¥å’Œç®€å•çš„æ­¥éª¤ã€‚å¦‚æœè¦æ›´åŠ è¯¦ç»†çš„ä¿¡æ¯è¯·é˜…è¯»è¿™ç¯‡å‚è€ƒã€‚</p>
<p>å¤‡ä»½ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-rake gitlab:backup:create</span><br></pre></td></tr></table></figure>
<p>å¤‡ä»½ä¼šç”Ÿæˆåœ¨<code>/var/opt/gitlab/backups</code>ç›®å½•ä¸‹ã€‚åç§°ç±»ä¼¼äº<code>1502357536_2017_08_10_9.4.3_gitlab_backup.tar</code>ã€‚ä¸‹é¢è¿™äº›é…ç½®ä¿¡æ¯ï¼Œæ²¡æœ‰åŒ…å«åœ¨backupæ–‡ä»¶é‡Œé¢ã€‚éœ€è¦æ‰‹åŠ¨è¿ç§»ã€‚</p>
<ul>
<li><code>/etc/gitlab/gitlab.rb</code> é…ç½®æ–‡ä»¶é¡»å¤‡ä»½</li>
<li><code>/var/opt/gitlab/nginx/conf</code> nginxé…ç½®æ–‡ä»¶</li>
<li><code>/etc/postfix/main.cfpostfix</code> é‚®ä»¶é…ç½®å¤‡ä»½</li>
</ul>
<p><img src="https://imgs.codewoody.com/uploads/big/109e8d518cabd20d26bb2bdc01feaaa0.png" alt="å¤‡ä»½å‘½ä»¤çš„æ‰§è¡Œ"></p>
<h2 id="2-2-åœ¨ç›®æ ‡æœºå™¨ä¸Šå®‰è£…gitlab"><a href="#2-2-åœ¨ç›®æ ‡æœºå™¨ä¸Šå®‰è£…gitlab" class="headerlink" title="2.2 åœ¨ç›®æ ‡æœºå™¨ä¸Šå®‰è£…gitlab"></a>2.2 åœ¨ç›®æ ‡æœºå™¨ä¸Šå®‰è£…gitlab</h2><p>è¿ç§»è¿‡ç¨‹ä¸­è¦æ±‚æºæœºå™¨å’Œç›®æ ‡æœºå™¨ä¸Šå®‰è£…çš„gitlabç‰ˆæœ¬æ˜¯ç›¸åŒçš„ã€‚å¦‚æœä¸åŒï¼Œå…¶å®æœ€å¥½çš„åšæ³•æ˜¯å…ˆå°†æºæœºå™¨ä¸Šçš„gitlabå‡çº§åˆ°æœ€æ–°çš„ç‰ˆæœ¬ã€‚ç„¶åå†ç”Ÿæˆå¤‡ä»½ã€‚</p>
<p><img src="https://imgs.codewoody.com/uploads/big/fc818b279eb9b922aa4b4adbb8c8ff57.png" alt="å¦‚ä½•æŸ¥çœ‹Gitlabç‰ˆæœ¬"></p>
<h2 id="2-3-ä¸Šä¼ å¤‡ä»½"><a href="#2-3-ä¸Šä¼ å¤‡ä»½" class="headerlink" title="2.3 ä¸Šä¼ å¤‡ä»½"></a>2.3 ä¸Šä¼ å¤‡ä»½</h2><p>ä½¿ç”¨<code>scp</code>å‘½ä»¤å°†å¤‡ä»½æ–‡ä»¶ä¸Šä¼ åˆ°ç›®æ ‡æœºå™¨çš„<code>/var/opt/gitlab/backups</code>ã€‚</p>
<blockquote>
<p>å¦‚æœscpä¸Šä¼ ç›®æ ‡æ–‡ä»¶æ–‡ä»¶å¤¹çš„æƒé™ä¸å¤Ÿï¼Œå¯ä»¥å…ˆä¸Šä¼ åˆ°è‡ªå·±çš„homeç›®å½•ä¸‹ï¼Œç„¶åsshç™»å½•åˆ°æœåŠ¡å™¨ä½¿ç”¨sudoè¿›è¡Œç§»åŠ¨ã€‚</p>
</blockquote>
<h2 id="2-4-åº”ç”¨å¤‡ä»½æ–‡ä»¶"><a href="#2-4-åº”ç”¨å¤‡ä»½æ–‡ä»¶" class="headerlink" title="2.4 åº”ç”¨å¤‡ä»½æ–‡ä»¶"></a>2.4 åº”ç”¨å¤‡ä»½æ–‡ä»¶</h2><p>é¦–å…ˆä¸ºäº†é¿å…æ½œåœ¨çš„æƒé™é—®é¢˜ï¼Œå°†å¤‡ä»½æ–‡ä»¶çš„æƒé™è®¾ç½®ä¸º777</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 1502357536_2017_08_10_9.4.3_gitlab_backup.tar</span><br></pre></td></tr></table></figure>
<p>ç„¶ååœæ­¢gitlabçš„ç›¸å…³æ•°æ®è¿æ¥æœåŠ¡</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl stop unicorn</span><br><span class="line">gitlab-ctl stop sidekiq</span><br></pre></td></tr></table></figure>
<p>ç„¶åç”¨ä¸‹é¢çš„å‘½ä»¤è¯»å–å¤‡ä»½ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-rake gitlab:backup:restore BACKUP=1502357536_2017_08_10_9.4.3</span><br></pre></td></tr></table></figure>
<p>åœ¨åç»­å‡ºç°çš„æ‰€æœ‰è¯¢é—®ä¸­è¾“å…¥yesï¼Œç­‰å¾…æ‰§è¡Œå®Œæ¯•ï¼Œå³å®Œæˆäº†è¿ç§»è¿‡ç¨‹ï¼Œæ¥ä¸‹æ¥å†æ¬¡å¯åŠ¨gitlab</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-ctl start</span><br></pre></td></tr></table></figure>
<h1 id="3-åˆ é™¤"><a href="#3-åˆ é™¤" class="headerlink" title="3 åˆ é™¤"></a>3 åˆ é™¤</h1><p>ä¸‹é¢çš„åˆ é™¤è¿‡ç¨‹åœ¨Ubuntu 16ä¸Šå¾—åˆ°éªŒè¯ï¼š</p>
<h2 id="3-1-ç§»é™¤gitlabæœåŠ¡"><a href="#3-1-ç§»é™¤gitlabæœåŠ¡" class="headerlink" title="3.1 ç§»é™¤gitlabæœåŠ¡"></a>3.1 ç§»é™¤gitlabæœåŠ¡</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-ctl uninstall</span><br></pre></td></tr></table></figure>
<h2 id="3-2-æ¸…æ¥šGitlabäº§ç”Ÿçš„æ•°æ®"><a href="#3-2-æ¸…æ¥šGitlabäº§ç”Ÿçš„æ•°æ®" class="headerlink" title="3.2 æ¸…æ¥šGitlabäº§ç”Ÿçš„æ•°æ®"></a>3.2 æ¸…æ¥šGitlabäº§ç”Ÿçš„æ•°æ®</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-ctl cleanse</span><br></pre></td></tr></table></figure>
<h2 id="3-3-åˆ é™¤Gitlabç”Ÿæˆçš„ç³»ç»Ÿè´¦æˆ·"><a href="#3-3-åˆ é™¤Gitlabç”Ÿæˆçš„ç³»ç»Ÿè´¦æˆ·" class="headerlink" title="3.3 åˆ é™¤Gitlabç”Ÿæˆçš„ç³»ç»Ÿè´¦æˆ·"></a>3.3 åˆ é™¤Gitlabç”Ÿæˆçš„ç³»ç»Ÿè´¦æˆ·</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gitlab-ctl remove-accounts</span><br></pre></td></tr></table></figure>
<h2 id="3-4-åˆ é™¤gitlab"><a href="#3-4-åˆ é™¤gitlab" class="headerlink" title="3.4 åˆ é™¤gitlab"></a>3.4 åˆ é™¤gitlab</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dpkg -P gitlab-ce</span><br></pre></td></tr></table></figure>
<h2 id="3-5-å…¶ä»–æ–‡ä»¶çš„åˆ é™¤"><a href="#3-5-å…¶ä»–æ–‡ä»¶çš„åˆ é™¤" class="headerlink" title="3.5 å…¶ä»–æ–‡ä»¶çš„åˆ é™¤"></a>3.5 å…¶ä»–æ–‡ä»¶çš„åˆ é™¤</h2><p>é™¤äº†ä¸Šè¿°æ“ä½œï¼ŒGitlabä½¿ç”¨çš„å…¶ä»–æ–‡ä»¶å¤¹è¿˜éœ€è¦æ‰‹åŠ¨åˆ é™¤ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li><code>/opt/gitlab</code>: åŒ…å«äº†Gitlabçš„åº”ç”¨ä»£ç å’Œä¾èµ–</li>
<li><code>/var/opt/gitlab</code>: åŒ…å«äº†åº”ç”¨çš„æ•°æ®å’Œé…ç½®ä¿¡æ¯(gitlab-ctl reconfigureçš„å†™å…¥å†…å®¹)</li>
<li><code>/etc/gitlab</code>: omnibus gitlabçš„é…ç½®ä¿¡æ¯ã€‚è¿™é‡Œçš„æ–‡ä»¶æ˜¯å”¯ä¸€å…è®¸ä½ æ‰‹åŠ¨ç¼–è¾‘çš„éƒ¨åˆ†</li>
<li><code>/var/log/gitlab</code>: æ—¥å¿—æ–‡ä»¶</li>
</ul>
<p>åœ¨ä½ å®Œæˆäº†å¼€å§‹çš„å››ä¸ªæ­¥éª¤åï¼Œè¿™é‡Œçš„å››ä¸ªæ–‡ä»¶å¤¹å¯ä»¥å®‰å…¨åœ°æ‰‹åŠ¨åˆ é™¤ã€‚</p>
<p>æ–‡ç« é“¾æ¥ <a href="http://www.codewoody.com/posts/25664/">http://www.codewoody.com/posts/25664/</a> </p></div><div class="article-meta" style="max-width:800px"><div class="tags"><i class="icon icon-tag"></i><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gitlab/">gitlab</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/æ•™ç¨‹/">æ•™ç¨‹</a><span class="tag-list-count">11</span></li></ul></div><div class="categories"><i class="icon icon-category"></i><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/æ•™ç¨‹/">æ•™ç¨‹</a><span class="category-list-count">11</span></li></ul></div></div><div class="article-comment" id="lv-container" data-id="city" data-uid="MTAyMC80MDkyMC8xNzQ0NQ==" style="max-width:800px"></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/posts/61013/"><i class="icon icon-arror-left"></i></a></li><li><a href="/posts/60823/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/huangy10" title="Github" target="_blank"><i class="icon icon-github"></i></a></li><li><a href="https://www.zhihu.com/people/woody-huang" title="Zhihu" target="_blank"><i class="icon icon-zhihu"></i></a></li><li><a href="mailto:woodyhuang1@gmail.com" title="Email" target="_blank"><i class="icon icon-email"></i></a></li></ul></div><div class="bottom"><p class="copyright">Â© 2019 æ²»éƒ¨å°‘è¾…<br><small>POWER BY <a href="https://hexo.io" target="_blank">HEXO</a></small><small>, THEME BY <a href="https://github.com/BoizZ/hexo-theme-laughing" target="_blank">LAUGHING</a></small></p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script><script src="https://www.googletagmanager.com/gtag/js?id=UA-114736006-1" async></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-114736006-1');</script></body></html>